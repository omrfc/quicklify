---
phase: 03-mcp-refactor
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/mcp/tools/serverProvision.ts
  - src/mcp/tools/serverManage.ts
  - src/mcp/tools/serverInfo.ts
  - tests/unit/mcp-server-provision.test.ts
  - tests/unit/mcp-server-manage.test.ts
  - tests/unit/mcp-server-info.test.ts
autonomous: true
requirements: [MCP-01, MCP-02, MCP-04]

must_haves:
  truths:
    - "Claude can provision a bare server via MCP by passing mode:'bare' parameter"
    - "Claude can add a bare server via MCP add action by passing mode:'bare' parameter"
    - "MCP status check for bare servers skips Coolify health (shows n/a)"
    - "MCP health check for bare servers returns SSH reachability not Coolify status"
    - "Existing MCP provision/manage/info calls without mode parameter work exactly as before"
    - "MCP tools use shared utils (mcpSuccess, mcpError, resolveServerForMcp) from mcp/utils.ts"
  artifacts:
    - path: "src/mcp/tools/serverProvision.ts"
      provides: "Provision tool with mode parameter support"
      exports: ["serverProvisionSchema", "handleServerProvision"]
    - path: "src/mcp/tools/serverManage.ts"
      provides: "Manage tool with mode parameter for add action"
      exports: ["serverManageSchema", "handleServerManage"]
    - path: "src/mcp/tools/serverInfo.ts"
      provides: "Info tool with bare mode awareness for status/health"
      exports: ["serverInfoSchema", "handleServerInfo"]
  key_links:
    - from: "src/mcp/tools/serverProvision.ts"
      to: "src/core/provision.ts"
      via: "passes mode to provisionServer()"
      pattern: "provisionServer.*mode"
    - from: "src/mcp/tools/serverManage.ts"
      to: "src/core/manage.ts"
      via: "passes mode to addServerRecord()"
      pattern: "addServerRecord.*mode"
    - from: "src/mcp/tools/serverInfo.ts"
      to: "src/utils/modeGuard.ts"
      via: "uses isBareServer for health check routing"
      pattern: "isBareServer"
---

<objective>
Refactor serverProvision, serverManage, and serverInfo MCP tools to support bare mode and use shared utilities.

Purpose: Enable Claude to provision and manage bare servers via MCP, and ensure status/health checks are mode-aware. Eliminate duplicated response formatting by using mcpSuccess/mcpError from utils.
Output: Three refactored MCP tools with bare mode support, backward-compatible schemas.
</objective>

<execution_context>
@C:/Users/Omrfc/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Omrfc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-mcp-refactor/03-CONTEXT.md
@.planning/phases/03-mcp-refactor/03-01-SUMMARY.md

<interfaces>
<!-- From Plan 01 (src/mcp/utils.ts) -->
```typescript
export type McpResponse = { content: Array<{ type: "text"; text: string }>; isError?: boolean };
export function resolveServerForMcp(params: { server?: string }, servers: ServerRecord[]): ServerRecord | undefined;
export function mcpSuccess(data: Record<string, unknown>): McpResponse;
export function mcpError(error: string, hint?: string, suggestedActions?: Array<{ command: string; reason: string }>): McpResponse;
export function requireProviderToken(provider: string): { token: string } | { error: McpResponse };
```

<!-- From Phase 2 (bare mode support in core) -->
From src/core/provision.ts:
```typescript
export interface ProvisionConfig {
  provider: string;
  region?: string;
  size?: string;
  name: string;
  template?: string;
  mode?: ServerMode;  // Added in Phase 2
}
```

From src/core/manage.ts:
```typescript
export interface AddServerParams {
  provider: string;
  ip: string;
  name: string;
  skipVerify?: boolean;
  apiToken?: string;
  mode?: ServerMode;  // Added in Phase 2
}
```

From src/utils/modeGuard.ts:
```typescript
export function isBareServer(server: ServerRecord): boolean;
export function getServerMode(server: ServerRecord): ServerMode;
```

From src/core/status.ts:
```typescript
// Already mode-aware from Phase 2 — bare servers get coolifyStatus: 'n/a'
export async function checkServerStatus(server: ServerRecord, apiToken: string): Promise<StatusResult>;
```

From src/utils/ssh.ts:
```typescript
export function sshExec(ip: string, command: string): Promise<{ code: number; stdout: string; stderr: string }>;
```
</interfaces>
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: Add bare mode to serverProvision and serverManage tools</name>
  <files>src/mcp/tools/serverProvision.ts, src/mcp/tools/serverManage.ts, tests/unit/mcp-server-provision.test.ts, tests/unit/mcp-server-manage.test.ts</files>
  <behavior>
    - serverProvision: schema has optional mode parameter with enum ['coolify','bare'] defaulting to 'coolify'
    - serverProvision: mode:'bare' is passed to provisionServer()
    - serverProvision: mode:'bare' success response shows SSH hint instead of Coolify health hint
    - serverProvision: mode omitted (default 'coolify') works identically to before
    - serverProvision: uses mcpSuccess/mcpError from mcp/utils
    - serverManage add: schema has optional mode parameter with enum ['coolify','bare'] defaulting to 'coolify'
    - serverManage add: mode:'bare' is passed to addServerRecord()
    - serverManage add: mode omitted works identically to before
    - serverManage: uses mcpSuccess/mcpError from mcp/utils
    - serverManage: remove and destroy actions unchanged
  </behavior>
  <action>
    **serverProvision.ts changes:**
    1. Add to schema: `mode: z.enum(["coolify", "bare"]).default("coolify").describe("Server mode: 'coolify' installs Coolify, 'bare' provisions generic VPS without Coolify. Default: coolify")`
    2. Add `mode` to handler params type
    3. Pass `mode: params.mode` to `provisionServer()` call
    4. In success response: if `mode === 'bare'`, change suggested_actions to show SSH connection hint and secure-setup instead of Coolify health check
    5. Include `mode` field in success response server object
    6. Replace inline JSON.stringify response patterns with `mcpSuccess()`/`mcpError()` from `../utils.js`

    **serverManage.ts changes:**
    1. Add to schema: `mode: z.enum(["coolify", "bare"]).default("coolify").describe("Server mode for 'add' action: 'coolify' or 'bare'. Default: coolify")`
    2. Add `mode` to handler params type
    3. In `add` action: pass `mode: params.mode` to `addServerRecord()` call
    4. In add success response: include `mode` field, adjust suggested_actions based on mode (bare: no Coolify health check)
    5. Replace inline response patterns with `mcpSuccess()`/`mcpError()` from `../utils.js`
    6. `remove` and `destroy` actions: replace response patterns with shared utils but NO logic changes

    Write tests FIRST. Add new test cases to existing test files for bare mode behavior. Existing tests must continue to pass (backward compat).
  </action>
  <verify>
    <automated>npx jest tests/unit/mcp-server-provision.test.ts tests/unit/mcp-server-manage.test.ts --no-coverage</automated>
  </verify>
  <done>serverProvision accepts mode:'bare' and passes to core; serverManage add accepts mode:'bare'; both use shared utils; existing tests pass</done>
</task>

<task type="auto" tdd="true">
  <name>Task 2: Add bare mode awareness to serverInfo tool</name>
  <files>src/mcp/tools/serverInfo.ts, tests/unit/mcp-server-info.test.ts</files>
  <behavior>
    - serverInfo status: bare server status shows coolifyStatus:'n/a' (already from core/status.ts)
    - serverInfo status: mode field included in server info response
    - serverInfo health single bare server: returns sshReachable status + mode:'bare', no Coolify URL
    - serverInfo health all servers: bare servers show SSH reachability, coolify servers show Coolify health
    - serverInfo list: includes mode field in server list response
    - serverInfo: uses mcpSuccess/mcpError and resolveServerForMcp from mcp/utils
    - serverInfo: existing Coolify server behavior unchanged
  </behavior>
  <action>
    **serverInfo.ts changes:**
    1. Import `isBareServer` from `../../utils/modeGuard.js` and `sshExec` from `../../utils/ssh.js`
    2. Import `mcpSuccess`, `mcpError`, `resolveServerForMcp` from `../utils.js`
    3. Remove local `resolveServer` function (no longer needed for this tool; status/health paths inline their lookups differently, but list/status already work. For health, use `resolveServerForMcp` where applicable)

    **list action:**
    - Include `mode: s.mode || 'coolify'` in each server object in formatServerList

    **status action:**
    - Include `mode` field in formatStatusResult output
    - Core's `checkServerStatus` already returns `coolifyStatus: 'n/a'` for bare servers — no code change needed for status logic itself
    - Replace response wrappers with mcpSuccess/mcpError

    **health action — single server:**
    - If `isBareServer(server)`: check SSH reachability via `sshExec(server.ip, "echo ok")` wrapped in try/catch
    - Return `{ server: server.name, ip: server.ip, mode: 'bare', sshReachable: true/false, suggested_actions: [...] }`
    - If Coolify server: existing `checkCoolifyHealth` flow unchanged

    **health action — all servers:**
    - In the `Promise.all` map: for bare servers, check SSH reachability instead of `checkCoolifyHealth`
    - Include `mode` in each result object
    - Summary counts: separate `bare` count from `running`/`notReachable`

    Replace response patterns with mcpSuccess/mcpError.

    Write tests FIRST for bare mode health check behavior. Existing tests must pass.
  </action>
  <verify>
    <automated>npx jest tests/unit/mcp-server-info.test.ts --no-coverage</automated>
  </verify>
  <done>serverInfo health returns SSH reachability for bare servers; status includes mode field; list includes mode field; shared utils used; existing behavior preserved</done>
</task>

</tasks>

<verification>
1. `npm run build` — TypeScript compiles without errors
2. `npx jest tests/unit/mcp-server-provision.test.ts tests/unit/mcp-server-manage.test.ts tests/unit/mcp-server-info.test.ts --no-coverage` — all new and existing tests pass
3. `npm test` — full test suite passes with no regressions
4. Verify backward compatibility: existing test cases for mode-less provision/manage/info pass unchanged
</verification>

<success_criteria>
- serverProvision schema has optional mode parameter, passes mode to provisionServer()
- serverManage add action has optional mode parameter, passes mode to addServerRecord()
- serverInfo health routes bare servers to SSH reachability check
- serverInfo status/list include mode field in responses
- All 3 tools use mcpSuccess/mcpError from mcp/utils.ts
- No breaking changes to existing schemas or behavior
</success_criteria>

<output>
After completion, create `.planning/phases/03-mcp-refactor/03-02-SUMMARY.md`
</output>
