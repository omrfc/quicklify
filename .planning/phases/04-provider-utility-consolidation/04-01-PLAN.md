---
phase: 04-provider-utility-consolidation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/constants.ts
  - src/types/index.ts
  - src/core/tokens.ts
  - src/core/manage.ts
  - src/core/provision.ts
  - src/commands/init.ts
  - src/commands/add.ts
  - src/commands/doctor.ts
  - src/utils/defaults.ts
  - src/utils/yamlConfig.ts
  - src/utils/prompts.ts
  - src/utils/serverSelect.ts
  - src/mcp/tools/serverInfo.ts
  - src/mcp/tools/serverManage.ts
  - src/mcp/tools/serverProvision.ts
autonomous: true
requirements:
  - REF-01

must_haves:
  truths:
    - "Provider list is defined in exactly one place (constants.ts) and all other files import from it"
    - "Adding a 5th provider requires editing only constants.ts PROVIDER_REGISTRY (all call sites auto-derive)"
    - "All invalid provider error messages are generated from the same helper function"
    - "MCP Zod schemas use the shared SUPPORTED_PROVIDERS tuple instead of inline string arrays"
    - "init.ts env token lookup uses PROVIDER_ENV_KEYS[provider] instead of if/else chain"
    - "All 2047+ existing tests pass without modification"
  artifacts:
    - path: "src/constants.ts"
      provides: "PROVIDER_REGISTRY, SUPPORTED_PROVIDERS, PROVIDER_ENV_KEYS, PROVIDER_DISPLAY_NAMES, invalidProviderError, SupportedProvider type"
      contains: "PROVIDER_REGISTRY"
    - path: "src/core/tokens.ts"
      provides: "Token lookup using PROVIDER_ENV_KEYS from constants"
      contains: "PROVIDER_ENV_KEYS"
    - path: "src/core/manage.ts"
      provides: "Provider validation using SUPPORTED_PROVIDERS from constants"
      contains: "SUPPORTED_PROVIDERS"
    - path: "src/mcp/tools/serverProvision.ts"
      provides: "Zod schema using SUPPORTED_PROVIDERS tuple"
      contains: "SUPPORTED_PROVIDERS"
  key_links:
    - from: "src/constants.ts"
      to: "src/core/tokens.ts"
      via: "PROVIDER_ENV_KEYS import"
      pattern: "import.*PROVIDER_ENV_KEYS.*from.*constants"
    - from: "src/constants.ts"
      to: "src/core/manage.ts"
      via: "SUPPORTED_PROVIDERS import"
      pattern: "import.*SUPPORTED_PROVIDERS.*from.*constants"
    - from: "src/constants.ts"
      to: "src/mcp/tools/serverInfo.ts"
      via: "SUPPORTED_PROVIDERS import for z.enum()"
      pattern: "z\\.enum\\(SUPPORTED_PROVIDERS\\)"
---

<objective>
Centralize the hardcoded provider list into a single PROVIDER_REGISTRY in constants.ts, derive all related constants (SUPPORTED_PROVIDERS, PROVIDER_ENV_KEYS, PROVIDER_DISPLAY_NAMES, SupportedProvider type) from it, create an invalidProviderError() helper, and update all 14 call sites across the codebase to import from the single source of truth.

Purpose: Eliminate provider list duplication so adding Dokploy (v1.3.0) requires editing only one object in constants.ts instead of 8+ files.

Output: Updated constants.ts with full registry; 14 files updated to import from it; zero hardcoded provider arrays remaining outside constants.ts.
</objective>

<execution_context>
@C:/Users/Omrfc/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Omrfc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-provider-utility-consolidation/04-CONTEXT.md

@src/constants.ts
@src/types/index.ts
@src/core/tokens.ts
@src/core/manage.ts
@src/core/provision.ts
@src/commands/init.ts
@src/commands/add.ts
@src/commands/doctor.ts
@src/utils/defaults.ts
@src/utils/yamlConfig.ts
@src/utils/prompts.ts
@src/utils/serverSelect.ts
@src/mcp/tools/serverInfo.ts
@src/mcp/tools/serverManage.ts
@src/mcp/tools/serverProvision.ts

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/constants.ts (CURRENT — will be extended):
```typescript
export const IP_WAIT: Record<string, { attempts: number; interval: number }> = { ... };
export const COOLIFY_MIN_WAIT: Record<string, number> = { ... };
export const BOOT_MAX_ATTEMPTS = 30;
export const BOOT_INTERVAL = 1000;
// ... other string constants
```

From src/types/index.ts (existing type — NOT changed by this plan):
```typescript
export type ServerMode = "coolify" | "bare";
```

From src/core/tokens.ts (CURRENT — ENV_KEYS will be replaced):
```typescript
const ENV_KEYS: Record<string, string> = {
  hetzner: "HETZNER_TOKEN",
  digitalocean: "DIGITALOCEAN_TOKEN",
  vultr: "VULTR_TOKEN",
  linode: "LINODE_TOKEN",
};
export function getProviderToken(provider: string): string | undefined { ... }
```

From src/core/manage.ts (CURRENT — VALID_PROVIDERS will be replaced):
```typescript
const VALID_PROVIDERS = ["hetzner", "digitalocean", "vultr", "linode"];
export function isValidProvider(provider: string): boolean { ... }
```

From src/providers/base.ts (existing CloudProvider interface — NOT changed):
```typescript
export interface CloudProvider {
  name: string;
  displayName: string;
  // ... methods
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PROVIDER_REGISTRY and derived exports in constants.ts</name>
  <files>src/constants.ts</files>
  <action>
Add the following to `src/constants.ts` (ABOVE the existing IP_WAIT constant, since the registry is the primary provider identity):

1. **PROVIDER_REGISTRY** — `as const` object with all 4 providers:
```typescript
export const PROVIDER_REGISTRY = {
  hetzner: {
    envKey: "HETZNER_TOKEN",
    displayName: "Hetzner Cloud",
    apiBaseUrl: "https://api.hetzner.cloud/v1",
  },
  digitalocean: {
    envKey: "DIGITALOCEAN_TOKEN",
    displayName: "DigitalOcean",
    apiBaseUrl: "https://api.digitalocean.com/v2",
  },
  vultr: {
    envKey: "VULTR_TOKEN",
    displayName: "Vultr",
    apiBaseUrl: "https://api.vultr.com/v2",
  },
  linode: {
    envKey: "LINODE_TOKEN",
    displayName: "Linode (Akamai)",
    apiBaseUrl: "https://api.linode.com/v4",
  },
} as const;
```

2. **SupportedProvider type** — derived from registry keys:
```typescript
export type SupportedProvider = keyof typeof PROVIDER_REGISTRY;
```

3. **SUPPORTED_PROVIDERS tuple** — for use in `z.enum()` and array validation:
```typescript
export const SUPPORTED_PROVIDERS = Object.keys(PROVIDER_REGISTRY) as [SupportedProvider, ...SupportedProvider[]];
```
Note: The cast to `[SupportedProvider, ...SupportedProvider[]]` is required because `z.enum()` expects a non-empty tuple type, and `Object.keys()` returns `string[]`.

4. **PROVIDER_ENV_KEYS** — derived from registry:
```typescript
export const PROVIDER_ENV_KEYS: Record<SupportedProvider, string> = Object.fromEntries(
  SUPPORTED_PROVIDERS.map((p) => [p, PROVIDER_REGISTRY[p].envKey]),
) as Record<SupportedProvider, string>;
```

5. **PROVIDER_DISPLAY_NAMES** — derived from registry:
```typescript
export const PROVIDER_DISPLAY_NAMES: Record<SupportedProvider, string> = Object.fromEntries(
  SUPPORTED_PROVIDERS.map((p) => [p, PROVIDER_REGISTRY[p].displayName]),
) as Record<SupportedProvider, string>;
```

6. **invalidProviderError()** — helper function:
```typescript
export function invalidProviderError(value: string): string {
  return `Invalid provider: ${value}. Use ${SUPPORTED_PROVIDERS.map((p) => `"${p}"`).join(", ")}.`;
}
```

Do NOT modify any existing constants (IP_WAIT, COOLIFY_MIN_WAIT, etc.) — they stay as-is.
  </action>
  <verify>
    <automated>npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>constants.ts exports PROVIDER_REGISTRY, SupportedProvider, SUPPORTED_PROVIDERS, PROVIDER_ENV_KEYS, PROVIDER_DISPLAY_NAMES, and invalidProviderError(). TypeScript compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Update core layer and utility files to use registry</name>
  <files>src/core/tokens.ts, src/core/manage.ts, src/core/provision.ts, src/utils/defaults.ts, src/utils/yamlConfig.ts, src/utils/serverSelect.ts, src/commands/doctor.ts</files>
  <action>
Update each file to import from `../constants.js` (or appropriate relative path) and remove inline provider lists:

**src/core/tokens.ts:**
- Remove the local `ENV_KEYS` constant (lines 3-8)
- Add import: `import { PROVIDER_ENV_KEYS } from "../constants.js";`
- In `getProviderToken()`: replace `ENV_KEYS[provider]` with `PROVIDER_ENV_KEYS[provider as keyof typeof PROVIDER_ENV_KEYS]`
- The function signature stays `(provider: string): string | undefined` for backward compatibility

**src/core/manage.ts:**
- Remove the local `VALID_PROVIDERS` constant (line 16)
- Add import: `import { SUPPORTED_PROVIDERS } from "../constants.js";`
- In `isValidProvider()`: replace `VALID_PROVIDERS.includes(provider)` with `(SUPPORTED_PROVIDERS as readonly string[]).includes(provider)`
- In `addServerRecord()` (wherever it references VALID_PROVIDERS for error messages): use `invalidProviderError()` from constants — add it to the import
- The cast `as readonly string[]` is needed because SUPPORTED_PROVIDERS is `SupportedProvider[]` but `provider` is `string`

**src/core/provision.ts:**
- In `provisionServer()` line 72: replace the hardcoded error string with `invalidProviderError(config.provider)` — add import from constants

**src/utils/defaults.ts:**
- Remove the inline `["hetzner", "digitalocean", "vultr", "linode"]` check (line 33)
- Add import: `import { SUPPORTED_PROVIDERS, invalidProviderError } from "../constants.js";`
- Replace the condition with `!(SUPPORTED_PROVIDERS as readonly string[]).includes(value)`
- Replace the error message with `invalidProviderError(value)`

**src/utils/yamlConfig.ts:**
- Remove inline provider arrays (lines 75)
- Add import: `import { SUPPORTED_PROVIDERS, invalidProviderError } from "../constants.js";`
- Line 73 (string type check warning): keep the static message as-is (it tells user valid values), OR use invalidProviderError to generate it
- Line 75-77: replace `["hetzner", ...].includes(...)` with `!(SUPPORTED_PROVIDERS as readonly string[]).includes(obj.provider)` and use `invalidProviderError(obj.provider)` for the message

**src/utils/serverSelect.ts:**
- Remove the local `envKeys` constant inside `promptApiToken()` (lines 71-76)
- Add import: `import { PROVIDER_ENV_KEYS } from "../constants.js";`
- Replace `envKeys[providerName]` with `PROVIDER_ENV_KEYS[providerName as keyof typeof PROVIDER_ENV_KEYS]`

**src/commands/doctor.ts:**
- Remove the local `PROVIDER_CONFIG` constant (lines 9-33)
- Add import: `import { PROVIDER_REGISTRY } from "../constants.js";`
- Refactor `validateToken()` to read from `PROVIDER_REGISTRY[provider as keyof typeof PROVIDER_REGISTRY]` — it needs `envKey` and `apiBaseUrl` + "/servers?per_page=1" (for Hetzner) etc.
- NOTE: doctor.ts has custom `validateUrl` per provider that differs from just `apiBaseUrl`. Options:
  - Option A: Keep a local `VALIDATE_PATHS` mapping that maps provider → validation endpoint path, and build the URL from `PROVIDER_REGISTRY[provider].apiBaseUrl + VALIDATE_PATHS[provider]`
  - Option B: Keep the local PROVIDER_CONFIG but derive `envVar` and `displayName` from PROVIDER_REGISTRY
  - **Use Option B** — it's simpler. Replace `envVar` and `displayName` references with PROVIDER_REGISTRY lookups, keep `validateUrl` local. Rename local constant to `DOCTOR_VALIDATE_URLS` with just `{ [provider]: string }` shape.

In ALL files: ensure `.js` extension on import paths (ESM convention).
  </action>
  <verify>
    <automated>npx tsc --noEmit && npm test -- --silent 2>&1 | tail -5</automated>
  </verify>
  <done>All 7 files import from constants.ts. No local provider list or env key mapping remains in any of them. Build compiles and all tests pass.</done>
</task>

<task type="auto">
  <name>Task 3: Update command layer and MCP tools to use registry</name>
  <files>src/commands/init.ts, src/commands/add.ts, src/utils/prompts.ts, src/mcp/tools/serverInfo.ts, src/mcp/tools/serverManage.ts, src/mcp/tools/serverProvision.ts</files>
  <action>
**src/commands/init.ts:**
1. Add import: `import { SUPPORTED_PROVIDERS, PROVIDER_ENV_KEYS, invalidProviderError } from "../constants.js";`
2. Line 81: replace `["hetzner", "digitalocean", "vultr", "linode"].includes(options.provider)` with `(SUPPORTED_PROVIDERS as readonly string[]).includes(options.provider)`
3. Line 83: replace hardcoded error string with `invalidProviderError(options.provider)`
4. Lines 113-124 (env token lookup chain): replace the 12-line if/else if chain with:
```typescript
const envKey = PROVIDER_ENV_KEYS[providerChoice as keyof typeof PROVIDER_ENV_KEYS];
if (envKey && process.env[envKey]) {
  apiToken = process.env[envKey]!;
  tokenSource = `${envKey} env var`;
}
```
Keep the `else` block that falls through to `getDeploymentConfig(provider)`.

**src/commands/add.ts:**
1. Add import: `import { SUPPORTED_PROVIDERS, PROVIDER_DISPLAY_NAMES, invalidProviderError } from "../constants.js";`
2. Lines 27-31 (inquirer choices): replace hardcoded choices with:
```typescript
choices: SUPPORTED_PROVIDERS.map((p) => ({
  name: PROVIDER_DISPLAY_NAMES[p],
  value: p,
})),
```
3. Line 37: remove local `validProviders` array
4. Line 38: replace `validProviders.includes(providerName!)` with `(SUPPORTED_PROVIDERS as readonly string[]).includes(providerName!)`
5. Line 39: replace error message with `invalidProviderError(providerName!)`

**src/utils/prompts.ts:**
1. Add import: `import { SUPPORTED_PROVIDERS, PROVIDER_DISPLAY_NAMES } from "../constants.js";`
2. Lines 14-18 (inquirer choices in getProviderConfig): replace hardcoded choices with:
```typescript
choices: SUPPORTED_PROVIDERS.map((p) => ({
  name: PROVIDER_DISPLAY_NAMES[p],
  value: p,
})),
```

**src/mcp/tools/serverInfo.ts:**
1. Add import: `import { SUPPORTED_PROVIDERS } from "../../constants.js";`
2. Line 20: replace `z.enum(["hetzner", "digitalocean", "vultr", "linode"])` with `z.enum(SUPPORTED_PROVIDERS)`
3. Line 133 (TypeScript type annotation): replace `"hetzner" | "digitalocean" | "vultr" | "linode"` with `SupportedProvider` — add `SupportedProvider` to the import from constants

**src/mcp/tools/serverManage.ts:**
1. Add import: `import { SUPPORTED_PROVIDERS } from "../../constants.js";`
2. Line 18: replace `z.enum(["hetzner", "digitalocean", "vultr", "linode"])` with `z.enum(SUPPORTED_PROVIDERS)`

**src/mcp/tools/serverProvision.ts:**
1. Add import: `import { SUPPORTED_PROVIDERS } from "../../constants.js";`
2. Line 10: replace `z.enum(["hetzner", "digitalocean", "vultr", "linode"])` with `z.enum(SUPPORTED_PROVIDERS)`
3. Line 46 (TypeScript type annotation): replace `"hetzner" | "digitalocean" | "vultr" | "linode"` with `SupportedProvider` — add to import

**NOTE on providerFactory.ts:** This file uses a `switch` statement to instantiate provider classes. It does NOT hardcode a provider list for validation — the switch cases are structural dispatchers, not validation arrays. Leave providerFactory.ts unchanged. If a provider is missing from the switch, the `default:` case throws. This is correct behavior — providerFactory needs to know the concrete class, which cannot be derived from the registry.

In ALL files: ensure `.js` extension on import paths (ESM convention).
  </action>
  <verify>
    <automated>npx tsc --noEmit && npm test -- --silent 2>&1 | tail -5</automated>
  </verify>
  <done>All 6 files import from constants.ts. No inline provider arrays remain in commands or MCP tools. `z.enum()` calls use SUPPORTED_PROVIDERS. init.ts env chain is 4 lines instead of 12. All tests pass.</done>
</task>

</tasks>

<verification>
After all tasks complete, run the following checks:

1. **No hardcoded provider lists remain outside constants.ts:**
```bash
grep -rn '"hetzner", "digitalocean"' src/ | grep -v constants.ts | grep -v node_modules
```
Expected: zero matches (providerFactory.ts switch cases are `case "hetzner":` not arrays)

2. **PROVIDER_REGISTRY exists in constants.ts:**
```bash
grep -n 'PROVIDER_REGISTRY' src/constants.ts
```
Expected: at least 1 match

3. **All tests pass:**
```bash
npm test
```
Expected: 2047+ tests pass, 0 failures

4. **Build succeeds:**
```bash
npm run build
```
Expected: clean exit

5. **Lint passes:**
```bash
npx eslint src/ --max-warnings=0
```
Expected: 0 errors, 0 warnings
</verification>

<success_criteria>
- `grep -rn '"hetzner", "digitalocean"' src/` returns matches ONLY in `src/constants.ts`
- `src/constants.ts` exports: PROVIDER_REGISTRY, SUPPORTED_PROVIDERS, PROVIDER_ENV_KEYS, PROVIDER_DISPLAY_NAMES, SupportedProvider, invalidProviderError
- `src/core/tokens.ts` has NO local ENV_KEYS constant
- `src/core/manage.ts` has NO local VALID_PROVIDERS constant
- `src/commands/init.ts` env token lookup is a PROVIDER_ENV_KEYS lookup (not if/else chain)
- MCP tools use `z.enum(SUPPORTED_PROVIDERS)` (not inline arrays)
- All existing tests pass without modification
- Build succeeds and ESLint reports zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-provider-utility-consolidation/04-01-SUMMARY.md`
</output>
