---
phase: 04-provider-utility-consolidation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/constants.ts
  - src/core/tokens.ts
  - src/core/manage.ts
  - src/commands/add.ts
  - src/commands/init.ts
  - src/utils/defaults.ts
  - src/utils/serverSelect.ts
  - src/utils/yamlConfig.ts
  - src/mcp/tools/serverInfo.ts
  - src/mcp/tools/serverManage.ts
  - src/mcp/tools/serverProvision.ts
autonomous: true
requirements:
  - REF-01

must_haves:
  truths:
    - "Provider list is defined in exactly one place (src/constants.ts)"
    - "Provider env key mapping is defined in exactly one place (src/constants.ts)"
    - "All call sites import from constants.ts instead of hardcoding the list"
    - "All 2047+ existing tests pass without modification"
    - "Build succeeds and ESLint reports zero errors"
  artifacts:
    - path: "src/constants.ts"
      provides: "SUPPORTED_PROVIDERS array and PROVIDER_ENV_KEYS record"
      exports: ["SUPPORTED_PROVIDERS", "PROVIDER_ENV_KEYS"]
      contains: "SUPPORTED_PROVIDERS"
    - path: "src/core/tokens.ts"
      provides: "getProviderToken using PROVIDER_ENV_KEYS from constants"
    - path: "src/core/manage.ts"
      provides: "isValidProvider using SUPPORTED_PROVIDERS from constants"
  key_links:
    - from: "src/core/tokens.ts"
      to: "src/constants.ts"
      via: "import PROVIDER_ENV_KEYS"
      pattern: "import.*PROVIDER_ENV_KEYS.*from.*constants"
    - from: "src/core/manage.ts"
      to: "src/constants.ts"
      via: "import SUPPORTED_PROVIDERS"
      pattern: "import.*SUPPORTED_PROVIDERS.*from.*constants"
    - from: "src/mcp/tools/serverProvision.ts"
      to: "src/constants.ts"
      via: "import SUPPORTED_PROVIDERS for Zod enum"
      pattern: "import.*SUPPORTED_PROVIDERS.*from.*constants"
---

<objective>
Centralize the hardcoded provider list and env key mapping into `src/constants.ts` as `SUPPORTED_PROVIDERS` and `PROVIDER_ENV_KEYS`, then update all 11 call sites across the codebase to import from the single source of truth.

Purpose: Eliminate provider list duplication (8+ files hardcode `["hetzner", "digitalocean", "vultr", "linode"]` and env key maps). Adding Dokploy in v1.3.0 will require changing only `src/constants.ts` instead of 8+ files.

Output: All provider-list references originate from `src/constants.ts`. Zero hardcoded provider arrays remain elsewhere.
</objective>

<execution_context>
@C:/Users/Omrfc/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Omrfc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/constants.ts (current exports — plan adds SUPPORTED_PROVIDERS + PROVIDER_ENV_KEYS):
```typescript
export const IP_WAIT: Record<string, { attempts: number; interval: number }>;
export const COOLIFY_MIN_WAIT: Record<string, number>;
export const BOOT_MAX_ATTEMPTS: number;
export const BOOT_INTERVAL: number;
export const COOLIFY_UPDATE_CMD: string;
export const COOLIFY_RESTART_CMD: string;
export const COOLIFY_SOURCE_DIR: string;
export const COOLIFY_DB_CONTAINER: string;
export const COOLIFY_DB_USER: string;
export const COOLIFY_DB_NAME: string;
```

From src/core/tokens.ts (current — local ENV_KEYS to be replaced):
```typescript
const ENV_KEYS: Record<string, string> = {
  hetzner: "HETZNER_TOKEN",
  digitalocean: "DIGITALOCEAN_TOKEN",
  vultr: "VULTR_TOKEN",
  linode: "LINODE_TOKEN",
};
export function getProviderToken(provider: string): string | undefined;
export function collectProviderTokensFromEnv(servers: ServerRecord[]): Map<string, string>;
```

From src/core/manage.ts (current — local VALID_PROVIDERS to be replaced):
```typescript
const VALID_PROVIDERS = ["hetzner", "digitalocean", "vultr", "linode"];
export function isValidProvider(provider: string): boolean;
```

Zod schema pattern used in MCP tools (all 3 use inline enum):
```typescript
z.enum(["hetzner", "digitalocean", "vultr", "linode"])
```
NOTE: Zod `z.enum()` requires a readonly tuple `[string, ...string[]]` — cast `SUPPORTED_PROVIDERS as const` or use `as [string, ...string[]]`.
</interfaces>
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: Add SUPPORTED_PROVIDERS and PROVIDER_ENV_KEYS to constants.ts</name>
  <files>src/constants.ts</files>
  <behavior>
    - SUPPORTED_PROVIDERS is an array of 4 strings: ["hetzner", "digitalocean", "vultr", "linode"]
    - SUPPORTED_PROVIDERS is exported as `as const` for type safety (enables `typeof SUPPORTED_PROVIDERS[number]`)
    - PROVIDER_ENV_KEYS is a Record mapping provider name to env var name
    - PROVIDER_ENV_KEYS maps: hetzner→HETZNER_TOKEN, digitalocean→DIGITALOCEAN_TOKEN, vultr→VULTR_TOKEN, linode→LINODE_TOKEN
    - Both are named exports
  </behavior>
  <action>
Add two new exports to the END of `src/constants.ts`:

```typescript
// Supported cloud providers (single source of truth)
export const SUPPORTED_PROVIDERS = ["hetzner", "digitalocean", "vultr", "linode"] as const;
export type SupportedProvider = (typeof SUPPORTED_PROVIDERS)[number];

// Provider API token environment variable mapping
export const PROVIDER_ENV_KEYS: Record<SupportedProvider, string> = {
  hetzner: "HETZNER_TOKEN",
  digitalocean: "DIGITALOCEAN_TOKEN",
  vultr: "VULTR_TOKEN",
  linode: "LINODE_TOKEN",
} as const;
```

The `as const` on SUPPORTED_PROVIDERS enables:
1. `SupportedProvider` type = `"hetzner" | "digitalocean" | "vultr" | "linode"`
2. Zod can use it: `z.enum(SUPPORTED_PROVIDERS)` (Zod accepts readonly tuples)
3. Array methods work: `SUPPORTED_PROVIDERS.includes(x)` with type narrowing

Write a unit test in `tests/unit/constants.test.ts` verifying:
- SUPPORTED_PROVIDERS contains exactly 4 providers
- PROVIDER_ENV_KEYS has entries for each provider in SUPPORTED_PROVIDERS
- Each env key follows the pattern `<PROVIDER_UPPERCASE>_TOKEN`
  </action>
  <verify>
    <automated>npx jest tests/unit/constants.test.ts --no-coverage</automated>
  </verify>
  <done>SUPPORTED_PROVIDERS and PROVIDER_ENV_KEYS are exported from constants.ts. Unit test passes.</done>
</task>

<task type="auto">
  <name>Task 2: Replace all hardcoded provider lists with SUPPORTED_PROVIDERS/PROVIDER_ENV_KEYS imports</name>
  <files>src/core/tokens.ts, src/core/manage.ts, src/commands/add.ts, src/commands/init.ts, src/utils/defaults.ts, src/utils/serverSelect.ts, src/utils/yamlConfig.ts, src/mcp/tools/serverInfo.ts, src/mcp/tools/serverManage.ts, src/mcp/tools/serverProvision.ts</files>
  <action>
Update each file to import from `src/constants.ts` and remove the local hardcoded list:

**1. `src/core/tokens.ts`** — Remove local `ENV_KEYS` record (lines 3-8). Import `PROVIDER_ENV_KEYS` from `../constants.js`. Update `getProviderToken()` to use `PROVIDER_ENV_KEYS[provider]` instead of `ENV_KEYS[provider]`.

**2. `src/core/manage.ts`** — Remove local `const VALID_PROVIDERS = [...]` (line 16). Import `SUPPORTED_PROVIDERS` from `../constants.js`. Update `isValidProvider()` to use `SUPPORTED_PROVIDERS.includes(provider as any)`. Update error message on line 71 to use `SUPPORTED_PROVIDERS.join(", ")`.

Note: `SUPPORTED_PROVIDERS` is `readonly`, so `.includes(provider)` requires casting. Use `(SUPPORTED_PROVIDERS as readonly string[]).includes(provider)` for type safety.

**3. `src/commands/add.ts`** (line 37) — Remove local `validProviders` array. Import `SUPPORTED_PROVIDERS` from `../constants.js`. Use `SUPPORTED_PROVIDERS.includes(...)` in the validation check.

**4. `src/commands/init.ts`** (lines 81-83) — Remove inline `["hetzner", "digitalocean", "vultr", "linode"].includes(...)`. Import `SUPPORTED_PROVIDERS` from `../constants.js`. Use `(SUPPORTED_PROVIDERS as readonly string[]).includes(options.provider)`. Update error message to use `SUPPORTED_PROVIDERS.join(", ")`.

**5. `src/utils/defaults.ts`** (lines 33-34) — Remove inline array. Import `SUPPORTED_PROVIDERS` from `../constants.js`. Use `(SUPPORTED_PROVIDERS as readonly string[]).includes(value)`. Update error message to use `SUPPORTED_PROVIDERS.join('", "')`.

**6. `src/utils/serverSelect.ts`** (lines 71-76) — Remove local `envKeys` record inside `promptApiToken()`. Import `PROVIDER_ENV_KEYS` from `../constants.js`. Use `PROVIDER_ENV_KEYS[providerName as SupportedProvider]` (or cast appropriately).

**7. `src/utils/yamlConfig.ts`** (lines 73-77) — Remove inline arrays. Import `SUPPORTED_PROVIDERS` from `../constants.js`. Use `(SUPPORTED_PROVIDERS as readonly string[]).includes(obj.provider)`. Update both error messages to reference `SUPPORTED_PROVIDERS.join('", "')`.

**8. `src/mcp/tools/serverInfo.ts`** (line 20) — Replace `z.enum(["hetzner", "digitalocean", "vultr", "linode"])` with `z.enum(SUPPORTED_PROVIDERS)`. Import `SUPPORTED_PROVIDERS` from `../../constants.js`. Also fix the `provider?:` type on line 133 to use `SupportedProvider` or remove the inline type literal.

**9. `src/mcp/tools/serverManage.ts`** (line 18) — Replace `z.enum([...])` with `z.enum(SUPPORTED_PROVIDERS)`. Import `SUPPORTED_PROVIDERS` from `../../constants.js`.

**10. `src/mcp/tools/serverProvision.ts`** (lines 9-10) — Replace `z.enum([...])` with `z.enum(SUPPORTED_PROVIDERS)`. Import `SUPPORTED_PROVIDERS` from `../../constants.js`. Also fix the `provider:` type on line 46 to use `SupportedProvider`.

**IMPORTANT**: Do NOT modify any test files. The tests import from these source files — the behavior must remain identical. Run the full test suite to verify.
  </action>
  <verify>
    <automated>npm run build && npx eslint src/ --no-warn-ignored && npx jest --no-coverage 2>&1 | tail -20</automated>
  </verify>
  <done>
    - `grep -r '"hetzner", "digitalocean"' src/` returns matches ONLY in `src/constants.ts`
    - All 2047+ tests pass
    - Build succeeds
    - ESLint clean
  </done>
</task>

</tasks>

<verification>
1. Run: `grep -r '"hetzner", "digitalocean"' src/` — should show ONLY `src/constants.ts`
2. Run: `grep -rn 'ENV_KEYS' src/core/tokens.ts` — should show import only, not local definition
3. Run: `grep -rn 'VALID_PROVIDERS' src/core/manage.ts` — should show no local definition
4. Run: `npm run build` — zero errors
5. Run: `npx eslint src/ --no-warn-ignored` — zero errors
6. Run: `npx jest --no-coverage` — all 2047+ tests pass
</verification>

<success_criteria>
- SUPPORTED_PROVIDERS and PROVIDER_ENV_KEYS exported from src/constants.ts
- Zero hardcoded provider lists remain in any file except src/constants.ts
- All existing tests pass without any test file modifications
- Build and lint clean
</success_criteria>

<output>
After completion, create `.planning/phases/04-provider-utility-consolidation/04-01-SUMMARY.md`
</output>
