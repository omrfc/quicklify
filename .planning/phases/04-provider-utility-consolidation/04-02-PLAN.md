---
phase: 04-provider-utility-consolidation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/providers/base.ts
  - src/providers/hetzner.ts
  - src/providers/digitalocean.ts
  - src/providers/vultr.ts
  - src/providers/linode.ts
autonomous: true
requirements:
  - REF-02

must_haves:
  truths:
    - "stripSensitiveData() is defined in exactly one place (src/providers/base.ts)"
    - "All 4 provider files import stripSensitiveData from base.ts instead of defining it locally"
    - "All 2047+ existing tests pass without modification"
    - "Build succeeds and ESLint reports zero errors"
  artifacts:
    - path: "src/providers/base.ts"
      provides: "Shared stripSensitiveData utility for all providers"
      exports: ["CloudProvider", "stripSensitiveData"]
      contains: "export function stripSensitiveData"
    - path: "src/providers/hetzner.ts"
      provides: "Hetzner provider importing stripSensitiveData from base"
    - path: "src/providers/digitalocean.ts"
      provides: "DigitalOcean provider importing stripSensitiveData from base"
    - path: "src/providers/vultr.ts"
      provides: "Vultr provider importing stripSensitiveData from base"
    - path: "src/providers/linode.ts"
      provides: "Linode provider importing stripSensitiveData from base"
  key_links:
    - from: "src/providers/hetzner.ts"
      to: "src/providers/base.ts"
      via: "import stripSensitiveData"
      pattern: "import.*stripSensitiveData.*from.*base"
    - from: "src/providers/digitalocean.ts"
      to: "src/providers/base.ts"
      via: "import stripSensitiveData"
      pattern: "import.*stripSensitiveData.*from.*base"
    - from: "src/providers/vultr.ts"
      to: "src/providers/base.ts"
      via: "import stripSensitiveData"
      pattern: "import.*stripSensitiveData.*from.*base"
    - from: "src/providers/linode.ts"
      to: "src/providers/base.ts"
      via: "import stripSensitiveData"
      pattern: "import.*stripSensitiveData.*from.*base"
---

<objective>
Consolidate the duplicate `stripSensitiveData()` function from 4 provider files into a single exported function in `src/providers/base.ts`, then update all providers to import it.

Purpose: Eliminate security-critical code duplication. Currently the identical function body exists in all 4 providers (hetzner, digitalocean, vultr, linode). Any fix to the stripping logic must be applied to 4 files — missing one file risks token leakage in error output.

Output: `stripSensitiveData()` is defined once in `base.ts` and imported by all providers.
</objective>

<execution_context>
@C:/Users/Omrfc/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Omrfc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/providers/base.ts (current — plan adds stripSensitiveData export):
```typescript
import type { Region, ServerSize, ServerConfig, ServerResult, SnapshotInfo, ServerMode } from "../types/index.js";
export interface CloudProvider { ... }
```

From src/providers/hetzner.ts (representative — identical in all 4):
```typescript
import axios from "axios";
import type { CloudProvider } from "./base.js";

function stripSensitiveData(error: unknown): void {
  if (axios.isAxiosError(error)) {
    if (error.config) {
      error.config.headers = undefined as unknown as typeof error.config.headers;
      error.config.data = undefined;
    }
    (error as unknown as Record<string, unknown>).request = undefined;
  }
}
```

Import pattern in each provider's catch blocks:
```typescript
catch (error) {
  stripSensitiveData(error);
  throw error;
}
```
</interfaces>
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: Move stripSensitiveData to base.ts and update all providers</name>
  <files>src/providers/base.ts, src/providers/hetzner.ts, src/providers/digitalocean.ts, src/providers/vultr.ts, src/providers/linode.ts</files>
  <behavior>
    - stripSensitiveData(error: unknown) is a named export from base.ts
    - It strips axios error config headers, config data, and request from error objects
    - All 4 provider files import it from "./base.js" instead of defining locally
    - All existing catch blocks continue to call stripSensitiveData(error) identically
    - No test files are modified
  </behavior>
  <action>
**Step 1: Add stripSensitiveData to `src/providers/base.ts`**

Add `import axios from "axios";` at the top of base.ts (it currently has no axios import since it's just an interface file).

Add the shared function AFTER the CloudProvider interface:

```typescript
/**
 * Strip sensitive data (headers, request body) from axios errors
 * before re-throwing. Prevents token leakage in error output.
 */
export function stripSensitiveData(error: unknown): void {
  if (axios.isAxiosError(error)) {
    if (error.config) {
      error.config.headers = undefined as unknown as typeof error.config.headers;
      error.config.data = undefined;
    }
    (error as unknown as Record<string, unknown>).request = undefined;
  }
}
```

**Step 2: Update all 4 provider files**

For each of `hetzner.ts`, `digitalocean.ts`, `vultr.ts`, `linode.ts`:

1. **Remove** the local `function stripSensitiveData(error: unknown): void { ... }` block (lines 5-13 in each, line 6-14 in linode.ts)
2. **Update** the existing `import type { CloudProvider } from "./base.js";` to also import `stripSensitiveData`:
   ```typescript
   import { stripSensitiveData } from "./base.js";
   import type { CloudProvider } from "./base.js";
   ```
   Or combine into one import if TypeScript allows mixed default/named imports with type-only:
   ```typescript
   import { stripSensitiveData, type CloudProvider } from "./base.js";
   ```
   Use the combined form — it's cleaner and the project uses ESM.

**Step 3: Write a unit test**

Create `tests/unit/strip-sensitive-data.test.ts`:
- Test that stripSensitiveData strips headers from an AxiosError
- Test that stripSensitiveData strips request from an AxiosError
- Test that stripSensitiveData is a no-op for non-Axios errors
- Test that stripSensitiveData handles null/undefined without throwing

**Step 4: Verify no local definitions remain**

Run `grep -rn 'function stripSensitiveData' src/providers/` — should return only `base.ts`.

**IMPORTANT**: Do NOT modify any existing test files. The `stripSensitiveData` function was private (not exported) in each provider before, so no tests reference it directly. The behavior change is purely structural.
  </action>
  <verify>
    <automated>npm run build && npx eslint src/providers/ --no-warn-ignored && npx jest --no-coverage 2>&1 | tail -20</automated>
  </verify>
  <done>
    - `grep -rn 'function stripSensitiveData' src/providers/` returns ONLY `src/providers/base.ts`
    - All 4 providers import stripSensitiveData from base.ts
    - All 2047+ tests pass
    - Build and lint clean
  </done>
</task>

</tasks>

<verification>
1. Run: `grep -rn 'function stripSensitiveData' src/providers/` — should show ONLY `src/providers/base.ts`
2. Run: `grep -rn 'stripSensitiveData' src/providers/hetzner.ts src/providers/digitalocean.ts src/providers/vultr.ts src/providers/linode.ts` — should show only import lines, no function definitions
3. Run: `npm run build` — zero errors
4. Run: `npx eslint src/providers/ --no-warn-ignored` — zero errors
5. Run: `npx jest --no-coverage` — all 2047+ tests pass
</verification>

<success_criteria>
- stripSensitiveData() exported from src/providers/base.ts
- Zero local stripSensitiveData definitions in hetzner.ts, digitalocean.ts, vultr.ts, linode.ts
- All existing tests pass without any test file modifications
- Build and lint clean
</success_criteria>

<output>
After completion, create `.planning/phases/04-provider-utility-consolidation/04-02-SUMMARY.md`
</output>
