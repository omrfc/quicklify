---
phase: 02-bare-mode
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/commands/status.ts
  - src/commands/list.ts
  - src/commands/health.ts
  - src/commands/update.ts
  - src/commands/maintain.ts
  - src/commands/logs.ts
  - src/core/status.ts
autonomous: true
requirements: [BARE-02, BARE-03, BARE-04, BARE-05, BARE-06, BARE-09]

must_haves:
  truths:
    - "Bare server status shows cloud status only, no Coolify health check"
    - "Status output for bare servers shows 'Mode: bare' and omits Coolify line"
    - "Server list table includes a Mode column showing coolify or bare"
    - "Health command on bare server shows mode:bare, skips Coolify health"
    - "Update command on bare server prints error and exits: command requires Coolify"
    - "Maintain command on bare server prints error and exits: command requires Coolify"
    - "Logs command with service=coolify on bare server prints error; system/docker logs still work"
    - "Destroy, secure, firewall, domain commands work unchanged on bare servers"
    - "All existing Coolify server behavior is unchanged"
  artifacts:
    - path: "src/commands/status.ts"
      provides: "Mode-aware status display"
      contains: "isBareServer"
    - path: "src/commands/list.ts"
      provides: "Mode column in server list"
      contains: "Mode"
    - path: "src/commands/health.ts"
      provides: "Mode-aware health check"
      contains: "isBareServer"
    - path: "src/commands/update.ts"
      provides: "Coolify-only guard"
      contains: "requireCoolifyMode"
    - path: "src/commands/maintain.ts"
      provides: "Coolify-only guard"
      contains: "requireCoolifyMode"
    - path: "src/commands/logs.ts"
      provides: "Mode-aware log service selection"
      contains: "isBareServer"
    - path: "src/core/status.ts"
      provides: "Mode-aware checkServerStatus"
      contains: "mode"
  key_links:
    - from: "src/commands/status.ts"
      to: "src/utils/modeGuard.ts"
      via: "isBareServer import"
      pattern: "isBareServer"
    - from: "src/commands/update.ts"
      to: "src/utils/modeGuard.ts"
      via: "requireCoolifyMode import"
      pattern: "requireCoolifyMode"
    - from: "src/core/status.ts"
      to: "src/types/index.ts"
      via: "ServerRecord mode field"
      pattern: "mode.*bare"
---

<objective>
Make status, list, and health commands mode-aware, and add Coolify-only guards to update, maintain, and logs commands.

Purpose: Bare servers must show cloud-only status (no Coolify health check), appear correctly in list output with a Mode column, and Coolify-specific commands must refuse to run on bare servers with a clear error. Infra commands (destroy, secure, firewall, domain) already work on any server and need no changes -- this plan confirms BARE-03/04/05/06 by ensuring the mode field doesn't break them.
Output: Mode-aware status/list/health display, Coolify-only guards on update/maintain/logs.
</objective>

<execution_context>
@C:/Users/Omrfc/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Omrfc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-bare-mode/02-CONTEXT.md
@.planning/phases/02-bare-mode/02-01-SUMMARY.md

<interfaces>
<!-- Contracts from Plan 01 -->

From src/utils/modeGuard.ts (created in Plan 01):
```typescript
import type { ServerRecord, ServerMode } from "../types/index.js";
export function getServerMode(server: ServerRecord): ServerMode;
export function isBareServer(server: ServerRecord): boolean;
export function requireCoolifyMode(server: ServerRecord, commandName: string): string | null;
```

From src/core/status.ts:
```typescript
export interface StatusResult {
  server: ServerRecord;
  serverStatus: string;
  coolifyStatus: string;
  error?: string;
}
export async function checkCoolifyHealth(ip: string): Promise<"running" | "not reachable">;
export async function getCloudServerStatus(server: ServerRecord, apiToken: string): Promise<string>;
export async function checkServerStatus(server: ServerRecord, apiToken: string): Promise<StatusResult>;
export async function checkAllServersStatus(servers: ServerRecord[], tokenMap: Map<string, string>): Promise<StatusResult[]>;
```

From src/types/index.ts (after Plan 01):
```typescript
export type ServerMode = "coolify" | "bare";
export interface ServerRecord {
  id: string; name: string; provider: string; ip: string;
  region: string; size: string; createdAt: string;
  mode?: ServerMode;
}
```
</interfaces>
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: Mode-aware status, list, and health commands + core status</name>
  <files>src/core/status.ts, src/commands/status.ts, src/commands/list.ts, src/commands/health.ts, tests/unit/status.test.ts, tests/unit/list.test.ts, tests/unit/health.test.ts, tests/unit/core-status.test.ts</files>
  <behavior>
    - Test: checkServerStatus for bare server returns coolifyStatus='n/a' (skips health check)
    - Test: checkServerStatus for coolify server calls checkCoolifyHealth (existing behavior)
    - Test: checkAllServersStatus handles mixed bare+coolify servers correctly
    - Test: statusCommand for bare server displays Mode: bare and omits Coolify line
    - Test: statusCommand for bare server does NOT attempt autostart
    - Test: printStatusTable includes Mode column
    - Test: listCommand output includes Mode column header
    - Test: healthCommand for bare server shows mode:bare, does not check Coolify health
  </behavior>
  <action>
    1. **src/core/status.ts** -- Mode-aware status:
       - Import `isBareServer` from `../utils/modeGuard.js`
       - In `checkServerStatus()`: if `isBareServer(server)`, skip `checkCoolifyHealth()` and set `coolifyStatus: "n/a"` instead
       - `checkAllServersStatus` needs no changes (it calls `checkServerStatus` which is now mode-aware)

    2. **src/commands/status.ts** -- Mode-aware display:
       - Import `isBareServer`, `getServerMode` from `../utils/modeGuard.js`
       - In `printStatusTable()`: add Mode column to table header and rows. Use `getServerMode(r.server)` for value. For bare servers, show coolify column as "n/a"
       - In single-server `statusCommand()`:
         - Show `Mode: bare` or `Mode: coolify` in output
         - If bare: skip Coolify status line, skip "Access Coolify" message, skip autostart logic
         - If bare: show `logger.info("Mode: bare (no platform installed)")` and SSH info instead
       - In `printStatusSummary()`: adjust summary to account for bare servers (don't count bare as "Coolify running")

    3. **src/commands/list.ts** -- Add Mode column:
       - Import `getServerMode` from `../utils/modeGuard.js`
       - Add "Mode" column to table header (after Provider, before IP or at end)
       - Show `getServerMode(server)` in each row

    4. **src/commands/health.ts** -- Mode-aware health:
       - Import `isBareServer` from `../utils/modeGuard.js`
       - In `checkServerHealth()`: if `isBareServer(server)`, return status='healthy' immediately (bare server health = SSH reachable, but we don't SSH here, so just mark as 'n/a' with a new status value). Better approach: add a status value 'bare' or skip and show 'n/a (bare)' in the table output.
       - Actually simplest: in `healthCommand()`, filter or annotate bare servers separately. For bare servers, show status as "n/a (bare)" in the table row, don't count them in Coolify health summary.

    5. Update tests for each command to verify mode-aware behavior.

    **BARE-03/04/05/06 note:** destroy, secure, firewall, domain commands do NOT need changes. They operate at cloud API or SSH level, which is mode-independent. The new `mode` field on ServerRecord is simply ignored by these commands. Existing tests confirm they work. This is noted in the plan to satisfy requirement traceability.
  </action>
  <verify>
    <automated>npx jest tests/unit/status.test.ts tests/unit/list.test.ts tests/unit/health.test.ts tests/unit/core-status.test.ts --no-coverage 2>&1 | tail -10</automated>
  </verify>
  <done>Status shows cloud-only for bare, list has Mode column, health handles bare servers, all existing Coolify behavior unchanged</done>
</task>

<task type="auto" tdd="true">
  <name>Task 2: Add Coolify-only guards to update, maintain, logs commands</name>
  <files>src/commands/update.ts, src/commands/maintain.ts, src/commands/logs.ts, tests/unit/update.test.ts, tests/unit/maintain.test.ts, tests/unit/logs.test.ts</files>
  <behavior>
    - Test: updateCommand on bare server exits with error "update command is not available for bare servers"
    - Test: updateCommand on coolify server proceeds normally (existing behavior)
    - Test: maintainCommand on bare server exits with error "maintain command is not available for bare servers"
    - Test: maintainCommand on coolify server proceeds normally (existing behavior)
    - Test: logsCommand with service=coolify on bare server exits with error about Coolify logs
    - Test: logsCommand with service=system on bare server works normally
    - Test: logsCommand with service=docker on bare server works normally
  </behavior>
  <action>
    1. **src/commands/update.ts** -- Add Coolify-only guard:
       - Import `requireCoolifyMode` from `../utils/modeGuard.js`
       - After `resolveServer()`, check mode:
         ```typescript
         const modeError = requireCoolifyMode(server, "update");
         if (modeError) {
           logger.error(modeError);
           return;
         }
         ```
       - For `--all` mode: filter out bare servers from the list, log a warning for skipped bare servers
       - Existing Coolify update logic unchanged

    2. **src/commands/maintain.ts** -- Add Coolify-only guard:
       - Import `requireCoolifyMode` from `../utils/modeGuard.js`
       - Same pattern: after resolveServer, check `requireCoolifyMode(server, "maintain")`
       - For `--all` mode: filter out bare servers, warn about skipped
       - Existing maintenance logic unchanged

    3. **src/commands/logs.ts** -- Service-aware guard:
       - Import `isBareServer` from `../utils/modeGuard.js`
       - After resolveServer, if `isBareServer(server)` AND `service === "coolify"`:
         ```typescript
         logger.error("Coolify logs are not available for bare servers. Use --service system or --service docker instead.");
         return;
         ```
       - System logs and docker logs should work on bare servers (they're OS-level)
       - If bare server and no explicit service flag, default to "system" instead of "coolify"

    4. Update tests for each command to verify guards.
  </action>
  <verify>
    <automated>npx jest tests/unit/update.test.ts tests/unit/maintain.test.ts tests/unit/logs.test.ts --no-coverage 2>&1 | tail -10</automated>
  </verify>
  <done>Update/maintain blocked on bare servers with clear error. Logs service=coolify blocked on bare, system/docker logs work. All coolify behavior unchanged.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- `npm test` passes all existing + new tests
- `npm run lint` passes
- Bare server status shows cloud-only, no Coolify line
- List command shows Mode column
- update/maintain on bare server prints error and exits
- logs --service coolify on bare server prints error
- Coolify servers behave identically to before
</verification>

<success_criteria>
- Bare server status: cloud status + mode:bare displayed, no Coolify health check attempted
- List table has Mode column (coolify or bare)
- Health command handles bare servers gracefully
- update, maintain: blocked on bare servers with "requires Coolify" error
- logs: coolify service blocked on bare, system/docker work
- destroy, secure, firewall, domain: work on bare servers unchanged (BARE-03/04/05/06)
- All existing Coolify command behavior preserved (BARE-09)
</success_criteria>

<output>
After completion, create `.planning/phases/02-bare-mode/02-03-SUMMARY.md`
</output>
