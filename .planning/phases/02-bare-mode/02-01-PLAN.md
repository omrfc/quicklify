---
phase: 02-bare-mode
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/index.ts
  - src/utils/cloudInit.ts
  - src/utils/modeGuard.ts
  - src/utils/config.ts
autonomous: true
requirements: [BARE-08, BARE-09]

must_haves:
  truths:
    - "ServerRecord interface includes mode field typed as 'coolify' | 'bare'"
    - "Existing servers without mode field are treated as coolify mode"
    - "Bare cloud-init script installs hardening packages but NOT Coolify"
    - "isBareServer() utility returns true when mode is 'bare'"
    - "requireCoolifyMode() utility returns a clear error message for bare servers"
  artifacts:
    - path: "src/types/index.ts"
      provides: "ServerRecord with optional mode field"
      contains: "mode"
    - path: "src/utils/cloudInit.ts"
      provides: "getBareCloudInit function"
      exports: ["getCoolifyCloudInit", "getBareCloudInit"]
    - path: "src/utils/modeGuard.ts"
      provides: "Mode detection and guard utilities"
      exports: ["isBareServer", "requireCoolifyMode", "getServerMode"]
    - path: "src/utils/config.ts"
      provides: "getServers with backward-compat mode defaulting"
  key_links:
    - from: "src/utils/modeGuard.ts"
      to: "src/types/index.ts"
      via: "import ServerRecord"
      pattern: "import.*ServerRecord.*from.*types"
    - from: "src/utils/config.ts"
      to: "src/types/index.ts"
      via: "ServerRecord with mode field"
      pattern: "mode.*coolify"
---

<objective>
Establish the foundation types, utilities, and cloud-init script for bare mode support.

Purpose: All subsequent plans depend on the ServerRecord mode field, the bare cloud-init script, and mode guard utilities. This plan creates the shared contracts first.
Output: Updated ServerRecord type, bare cloud-init function, mode guard utility module, backward-compatible config reader.
</objective>

<execution_context>
@C:/Users/Omrfc/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Omrfc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-bare-mode/02-CONTEXT.md

<interfaces>
<!-- Key types and contracts the executor needs -->

From src/types/index.ts:
```typescript
export interface ServerRecord {
  id: string;
  name: string;
  provider: string;
  ip: string;
  region: string;
  size: string;
  createdAt: string;
}
```

From src/utils/cloudInit.ts:
```typescript
export function getCoolifyCloudInit(serverName: string): string;
```

From src/utils/config.ts:
```typescript
export function getServers(): ServerRecord[];
export function saveServer(record: ServerRecord): void;
export function removeServer(id: string): boolean;
export function findServer(query: string): ServerRecord | undefined;
export function findServers(query: string): ServerRecord[];
export { CONFIG_DIR, SERVERS_FILE, BACKUPS_DIR };
```
</interfaces>
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: Add mode field to ServerRecord and update config backward compat</name>
  <files>src/types/index.ts, src/utils/config.ts, tests/unit/config.test.ts</files>
  <behavior>
    - Test: ServerRecord with mode='bare' is accepted by getServers/saveServer
    - Test: ServerRecord without mode field defaults to 'coolify' when loaded by getServers
    - Test: ServerRecord with mode='coolify' is preserved as-is
    - Test: BackupManifest gains optional mode field
  </behavior>
  <action>
    1. In `src/types/index.ts`:
       - Add `mode?: "coolify" | "bare"` to the `ServerRecord` interface (optional for backward compat)
       - Add `mode?: "coolify" | "bare"` to the `BackupManifest` interface (for Plan 04)
       - Add `ServerMode` type export: `export type ServerMode = "coolify" | "bare"`
       - Add `mode?: ServerMode` to `InitOptions` interface

    2. In `src/utils/config.ts`:
       - Update `getServers()` to normalize loaded records: if a record has no `mode` field, set `mode: "coolify"` before returning. This ensures all consumers see a consistent mode field.
       - Use: `return parsed.map((s: ServerRecord) => ({ ...s, mode: s.mode || "coolify" }))`

    3. Update existing config tests to verify mode defaulting behavior.
  </action>
  <verify>
    <automated>npx jest tests/unit/config.test.ts --no-coverage -- --passWithNoTests 2>&1 | tail -5</automated>
  </verify>
  <done>ServerRecord has mode field, getServers defaults mode to 'coolify' for records without it, all existing tests pass</done>
</task>

<task type="auto" tdd="true">
  <name>Task 2: Create bare cloud-init script</name>
  <files>src/utils/cloudInit.ts, tests/unit/cloudInit.test.ts</files>
  <behavior>
    - Test: getBareCloudInit(name) returns a string starting with #!/bin/bash
    - Test: getBareCloudInit(name) includes fail2ban installation
    - Test: getBareCloudInit(name) includes ufw setup with ports 22, 80, 443
    - Test: getBareCloudInit(name) includes unattended-upgrades
    - Test: getBareCloudInit(name) does NOT contain "coolify" or "coollabs"
    - Test: getBareCloudInit(name) sanitizes server name (strips unsafe chars)
  </behavior>
  <action>
    Add `getBareCloudInit(serverName: string): string` to `src/utils/cloudInit.ts` alongside the existing `getCoolifyCloudInit`.

    The bare cloud-init script should:
    - Start with `#!/bin/bash` and `set +e`
    - Log to `/var/log/quicklify-install.log`
    - Wait for network connectivity (same pattern as Coolify cloud-init)
    - `apt-get update -y`
    - Install hardening packages: `fail2ban`, `ufw`, `unattended-upgrades`
    - Configure UFW: allow 22/tcp, 80/tcp, 443/tcp, enable
    - Configure unattended-upgrades (enable automatic security updates)
    - Print completion message with server name and SSH info
    - NOT install Docker, Coolify, or any application platform

    Sanitize server name same way as getCoolifyCloudInit: `serverName.replace(/[^a-z0-9-]/g, "")`
  </action>
  <verify>
    <automated>npx jest tests/unit/cloudInit.test.ts --no-coverage 2>&1 | tail -5</automated>
  </verify>
  <done>getBareCloudInit produces a valid cloud-init script with hardening but no Coolify, all tests pass</done>
</task>

<task type="auto" tdd="true">
  <name>Task 3: Create mode guard utility module</name>
  <files>src/utils/modeGuard.ts, tests/unit/modeGuard.test.ts</files>
  <behavior>
    - Test: getServerMode(record with mode='bare') returns 'bare'
    - Test: getServerMode(record with mode='coolify') returns 'coolify'
    - Test: getServerMode(record with no mode) returns 'coolify'
    - Test: isBareServer(record with mode='bare') returns true
    - Test: isBareServer(record with mode='coolify') returns false
    - Test: isBareServer(record with no mode) returns false
    - Test: requireCoolifyMode(bare record, 'health') returns error string containing command name
    - Test: requireCoolifyMode(coolify record, 'health') returns null
  </behavior>
  <action>
    Create new file `src/utils/modeGuard.ts` with three exported functions:

    ```typescript
    import type { ServerRecord, ServerMode } from "../types/index.js";

    export function getServerMode(server: ServerRecord): ServerMode {
      return server.mode || "coolify";
    }

    export function isBareServer(server: ServerRecord): boolean {
      return getServerMode(server) === "bare";
    }

    export function requireCoolifyMode(server: ServerRecord, commandName: string): string | null {
      if (isBareServer(server)) {
        return `The "${commandName}" command is not available for bare servers. This command requires Coolify.`;
      }
      return null;
    }
    ```

    Create `tests/unit/modeGuard.test.ts` with the behavior tests listed above.
  </action>
  <verify>
    <automated>npx jest tests/unit/modeGuard.test.ts --no-coverage 2>&1 | tail -5</automated>
  </verify>
  <done>Mode guard utility module created with getServerMode, isBareServer, requireCoolifyMode functions, all tests pass</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds (no type errors)
- `npm test` passes all existing + new tests
- `npm run lint` passes
- ServerRecord type includes mode field
- getBareCloudInit exported from cloudInit.ts
- modeGuard.ts exports three functions
</verification>

<success_criteria>
- ServerRecord interface has `mode?: "coolify" | "bare"` field
- getServers() defaults mode to 'coolify' for legacy records
- getBareCloudInit() produces hardening-only cloud-init script
- isBareServer/requireCoolifyMode utilities work correctly
- All existing tests pass (no regressions from type addition)
- Build + lint clean
</success_criteria>

<output>
After completion, create `.planning/phases/02-bare-mode/02-01-SUMMARY.md`
</output>
