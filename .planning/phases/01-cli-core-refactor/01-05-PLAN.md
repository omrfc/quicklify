---
phase: 01-cli-core-refactor
plan: 05
type: execute
wave: 3
depends_on:
  - "01-03"
  - "01-04"
files_modified:
  - src/commands/init.ts
  - src/commands/status.ts
  - src/commands/logs.ts
autonomous: true
requirements:
  - REF-01
  - REF-03
  - REF-04
  - REF-05

must_haves:
  truths:
    - "init.ts imports IP_WAIT and COOLIFY_MIN_WAIT from constants.ts (not locally defined)"
    - "init.ts imports firewallSetup and secureSetup functions that delegate to core/"
    - "status.ts is a thin wrapper around core/status.ts functions"
    - "logs.ts is already thin (verified)"
    - "All 1758+ tests pass at 80%+ coverage"
    - "All existing CLI command signatures and behaviors are unchanged"
  artifacts:
    - path: "src/commands/init.ts"
      provides: "Refactored init command importing from constants and core-delegating subcommands"
      contains: "import.*from.*constants"
    - path: "src/commands/status.ts"
      provides: "Thin CLI wrapper around core/status.ts"
      contains: "import.*from.*core/status"
  key_links:
    - from: "src/commands/init.ts"
      to: "src/constants.ts"
      via: "import { IP_WAIT, COOLIFY_MIN_WAIT }"
      pattern: "import.*IP_WAIT.*COOLIFY_MIN_WAIT.*from.*constants"
    - from: "src/commands/init.ts"
      to: "src/commands/firewall.ts"
      via: "import { firewallSetup }"
      pattern: "import.*firewallSetup.*from.*firewall"
    - from: "src/commands/init.ts"
      to: "src/commands/secure.ts"
      via: "import { secureSetup }"
      pattern: "import.*secureSetup.*from.*secure"
---

<objective>
Refactor the most complex commands (init.ts, status.ts) and verify the final state of all refactored commands including test coverage.

Purpose: init.ts is the most complex command (536 lines) and status.ts is already partially delegating. This plan ensures the remaining duplication is resolved and does the final verification pass across the entire codebase.

Output: Fully refactored init.ts and status.ts. Full test suite pass with 80%+ coverage confirmed.
</objective>

<execution_context>
@C:/Users/Omrfc/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Omrfc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-cli-core-refactor/01-CONTEXT.md
@.planning/phases/01-cli-core-refactor/01-01-SUMMARY.md
@.planning/phases/01-cli-core-refactor/01-02-SUMMARY.md
@.planning/phases/01-cli-core-refactor/01-03-SUMMARY.md
@.planning/phases/01-cli-core-refactor/01-04-SUMMARY.md

<interfaces>
<!-- init.ts current structure -->
```typescript
// Lines 29-42: LOCAL constants (IP_WAIT, COOLIFY_MIN_WAIT) — already extracted by Plan 01
// Line 22: import { firewallSetup } from "./firewall.js" — this function should now delegate to core/
// Line 23: import { secureSetup } from "./secure.js" — this function should now delegate to core/
// Lines 262-289: uploadSshKeyToProvider — local to init.ts, duplicated with core/provision.ts uploadSshKeyBestEffort
// Lines 291-535: deployServer — the main deployment orchestration (CLI-specific, keeps here)
```

<!-- status.ts current structure -->
```typescript
// Already imports from core/status.ts: getCloudServerStatus, checkAllServersStatus, checkCoolifyHealth
// Lines 14-16: LOCAL COOLIFY_RESTART_CMD — already extracted by Plan 01
// Lines 22-34: printStatusTable — CLI-specific, stays
// Lines 36-44: printStatusSummary — CLI-specific, stays
// Lines 46-65: statusAll — CLI wrapper (already uses core), stays
// Lines 67-99: autostartCoolify — CLI-specific (SSH exec + output), stays
// Lines 101-148: statusCommand — CLI entry point, stays
```

<!-- After Plan 01, constants imported from src/constants.ts -->
<!-- After Plan 02, firewall.ts and secure.ts import pure functions from core/ -->
<!-- After Plan 03, add/destroy/restart/health delegate to core/ -->
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify and finalize init.ts refactoring</name>
  <files>src/commands/init.ts</files>
  <action>
init.ts is the most complex command. After Plan 01, its local IP_WAIT and COOLIFY_MIN_WAIT constants should already be replaced with imports from constants.ts. This task verifies and completes any remaining refactoring.

1. **Verify constants import**: Confirm init.ts imports `IP_WAIT` and `COOLIFY_MIN_WAIT` from `../constants.js` (done by Plan 01). If not done yet, do it now.

2. **Verify firewall/secure imports**: init.ts imports `firewallSetup` from `./firewall.js` and `secureSetup` from `./secure.js`. After Plan 02, these command functions internally delegate to core/. The import chain is fine: init → commands/firewall → core/firewall. No change needed here.

3. **uploadSshKeyToProvider** (lines 262-289): This is similar to `uploadSshKeyBestEffort` in core/provision.ts but NOT identical — init.ts version uses spinner/logger (CLI output), core version uses process.stderr.write. Keep the CLI version in init.ts since it's CLI-specific output. This is NOT duplication — the core version is for MCP (no spinner), the CLI version is for interactive use (with spinner).

4. **deployServer** (lines 291-535): This is the main deployment orchestration. It handles interactive retries, server creation, IP polling, health check, full-setup, success message, onboarding. This is CLI-specific orchestration that:
   - Uses spinners and logger (CLI output)
   - Handles interactive retries with prompts
   - Manages complex state flow

   This function stays in init.ts. It's NOT duplicated in core/ — core/provision.ts has a different, simpler version for MCP.

5. **Final check**: Ensure no other constants or pure functions are duplicated between init.ts and any core/ file. The only remaining "duplication" should be the uploadSshKeyToProvider vs uploadSshKeyBestEffort — which is intentional (different output channels).

IMPORTANT: init.ts should NOT be massively restructured. The user decision says "Mevcut CLI komutlarının dış davranışı %100 aynı kalacak". The key refactoring for init.ts is constants extraction (Plan 01) and ensuring firewall/secure subcommands use core/ (Plan 02). The deploy orchestration is CLI-specific.
  </action>
  <verify>
    <automated>npm run build && npm test -- --testPathPattern="init" 2>&1 | tail -10</automated>
  </verify>
  <done>init.ts imports constants from src/constants.ts. No duplicated constants or pure functions remain. Init command behavior unchanged. Tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Final verification — full test suite, coverage check, and dead code audit</name>
  <files>src/commands/status.ts, src/commands/logs.ts</files>
  <action>
1. **Verify status.ts**: Already imports from core/status.ts. After Plan 01, COOLIFY_RESTART_CMD should be imported from constants.ts. Verify this is done. If not, update the import.

2. **Verify logs.ts**: Already imports `buildLogCommand` from core/logs.ts. Should be thin. Verify no duplicated logic.

3. **Run full test suite with coverage**:
   ```bash
   npm test -- --coverage 2>&1 | tail -30
   ```
   Verify:
   - All 1758+ tests pass
   - Coverage >= 80% overall
   - No regressions

4. **Dead code audit**: After refactoring, some exports from command files may no longer be needed (if they were only re-exported for backwards compat but nobody imports them). Run:
   ```bash
   # Check for unused exports in refactored commands
   grep -rn "export function\|export const\|export async" src/commands/secure.ts src/commands/firewall.ts src/commands/domain.ts
   ```
   For each export, verify it's imported somewhere:
   ```bash
   grep -rn "from.*commands/secure" src/ tests/
   grep -rn "from.*commands/firewall" src/ tests/
   grep -rn "from.*commands/domain" src/ tests/
   ```
   If a pure function is still exported from the command file but only imported by tests, update the test to import from core/ instead and remove the re-export from the command.

5. **Duplication final check**: Verify NO pure function is defined in both a command file and its core/ counterpart:
   ```bash
   # For each core module, check no command duplicates its functions
   for mod in secure firewall domain backup manage maintain snapshot; do
     echo "=== $mod ==="
     grep "export function" src/core/$mod.ts | while read line; do
       fn=$(echo "$line" | sed 's/export function \([a-zA-Z]*\).*/\1/')
       if grep -q "export function $fn\|function $fn" src/commands/$mod.ts 2>/dev/null; then
         echo "DUPLICATE: $fn in both core/$mod.ts and commands/$mod.ts"
       fi
     done
   done
   ```

6. **Coverage check**: If coverage dropped below 80%, identify which files need additional tests and add them. The most likely files needing test updates are refactored commands where tests imported functions that moved.

7. **Lint check**:
   ```bash
   npm run lint
   ```
   Fix any unused import warnings in refactored files.
  </action>
  <verify>
    <automated>npm run build && npm run lint && npm test -- --coverage 2>&1 | grep -E "(Tests:|Suites:|coverage|Statements|Branches|Functions|Lines)" | head -10</automated>
  </verify>
  <done>Full test suite passes (1758+ tests). Coverage >= 80%. No lint errors. No duplicated pure functions between commands/ and core/. All refactoring complete.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. `npm run lint` succeeds (no errors)
3. `npm test -- --coverage` passes all tests at 80%+ coverage
4. No function is defined in both a command file and its core/ counterpart
5. All command files import constants from src/constants.ts (no local constant duplication)
6. All command files that have core/ counterparts import business logic from core/
</verification>

<success_criteria>
- Phase 1 complete: All CLI commands are thin wrappers around core/ modules
- REF-01: Every CLI command that had duplicated logic now calls the equivalent core/ function
- REF-02: Shared constants defined once in src/constants.ts and imported everywhere
- REF-03: Commands only handle CLI concerns — business logic lives in core/
- REF-04: No breaking changes to existing CLI command signatures or behavior
- REF-05: Test suite passes at 80%+ coverage with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/01-cli-core-refactor/01-05-SUMMARY.md`
</output>
