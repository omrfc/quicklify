---
phase: 01-cli-core-refactor
plan: 04
type: execute
wave: 2
depends_on:
  - "01-01"
  - "01-02"
files_modified:
  - src/commands/backup.ts
  - src/commands/restore.ts
  - src/commands/maintain.ts
  - src/commands/update.ts
  - src/commands/snapshot.ts
  - src/commands/monitor.ts
  - src/core/backup.ts
  - src/core/maintain.ts
  - src/core/snapshot.ts
autonomous: true
requirements:
  - REF-01
  - REF-03
  - REF-04
  - REF-05

must_haves:
  truths:
    - "backup command delegates backup creation, listing, and manifest handling to core/backup.ts"
    - "restore command delegates restore logic to core/backup.ts"
    - "maintain command delegates update/restart/maintain orchestration to core/maintain.ts"
    - "update command delegates Coolify update to core/maintain.ts"
    - "snapshot command delegates snapshot create/list/delete to core/snapshot.ts"
    - "monitor command is already thin (imports from core/logs.ts) — verify and clean up"
    - "All commands produce identical output and behavior"
  artifacts:
    - path: "src/commands/backup.ts"
      provides: "Thin CLI wrapper around core/backup.ts"
      contains: "import.*from.*core/backup"
    - path: "src/commands/maintain.ts"
      provides: "Thin CLI wrapper around core/maintain.ts"
      contains: "import.*from.*core/maintain"
    - path: "src/commands/snapshot.ts"
      provides: "Thin CLI wrapper around core/snapshot.ts"
      contains: "import.*from.*core/snapshot"
  key_links:
    - from: "src/commands/backup.ts"
      to: "src/core/backup.ts"
      via: "import backup functions"
      pattern: "import.*from.*core/backup"
    - from: "src/commands/maintain.ts"
      to: "src/core/maintain.ts"
      via: "import maintain/update functions"
      pattern: "import.*from.*core/maintain"
    - from: "src/commands/snapshot.ts"
      to: "src/core/snapshot.ts"
      via: "import snapshot functions"
      pattern: "import.*from.*core/snapshot"
---

<objective>
Refactor backup, restore, maintain, update, snapshot, and monitor commands to delegate business logic to core/ modules.

Purpose: These medium-complexity commands contain duplicated pure functions (backup formatTimestamp, buildPgDumpCommand, etc.) and inline business logic that should live in core/. After refactoring, commands only handle CLI concerns.

Output: Six thinner command files. Core modules may gain new async wrapper functions where they don't exist yet.
</objective>

<execution_context>
@C:/Users/Omrfc/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Omrfc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-cli-core-refactor/01-CONTEXT.md
@.planning/phases/01-cli-core-refactor/01-01-SUMMARY.md
@.planning/phases/01-cli-core-refactor/01-02-SUMMARY.md

<interfaces>
<!-- Core backup functions (already exist in core/backup.ts) -->
```typescript
export function formatTimestamp(date: Date): string
export function getBackupDir(serverName: string): string
export function buildPgDumpCommand(): string
export function buildConfigTarCommand(): string
export function buildCleanupCommand(): string
// Core has full createBackup() and restoreBackup() async wrappers
export async function createBackup(ip: string, serverName: string, provider: string): Promise<BackupCreateResult>
export async function restoreBackup(ip: string, backupId: string, serverName: string): Promise<BackupRestoreResult>
export function listBackups(serverName: string): BackupEntry[]
```

<!-- Core maintain functions (already exist in core/maintain.ts) -->
```typescript
export async function updateCoolify(server: ServerRecord): Promise<UpdateResult>
export async function restartServer(server: ServerRecord, apiToken: string): Promise<RestartResult>
export async function maintainServer(server: ServerRecord, apiToken: string, options?: { skipReboot?: boolean }): Promise<MaintainResult>
```

<!-- Core snapshot functions (already exist in core/snapshot.ts) -->
```typescript
export async function createSnapshot(server: ServerRecord, apiToken: string): Promise<SnapshotCreateResult>
export async function listSnapshots(server: ServerRecord, apiToken: string): Promise<SnapshotListResult>
export async function deleteSnapshot(server: ServerRecord, snapshotId: string, apiToken: string): Promise<SnapshotDeleteResult>
```

<!-- commands/backup.ts duplicated pure functions to remove -->
```typescript
// These are in BOTH commands/backup.ts AND core/backup.ts:
export function formatTimestamp(date: Date): string
export function getBackupDir(serverName: string): string
export function buildPgDumpCommand(): string
export function buildConfigTarCommand(): string
export function buildCleanupCommand(): string
export function listBackups(serverName: string): BackupEntry[]
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor backup.ts and restore.ts to delegate to core/backup.ts</name>
  <files>src/commands/backup.ts, src/commands/restore.ts, src/core/backup.ts</files>
  <action>
**backup.ts refactoring:**

1. Read `src/core/backup.ts` fully to understand what async wrappers exist. Core/backup.ts already has `createBackup()`, `restoreBackup()`, `listBackups()` — verify by reading the full file.

2. Remove duplicated pure functions from `src/commands/backup.ts`:
   - `formatTimestamp` → import from core/backup.ts
   - `getBackupDir` → import from core/backup.ts
   - `buildPgDumpCommand` → import from core/backup.ts
   - `buildConfigTarCommand` → import from core/backup.ts
   - `buildCleanupCommand` → import from core/backup.ts
   - `listBackups` → import from core/backup.ts (if signature matches)

3. For the main backup flow: If core/backup.ts has a `createBackup()` async wrapper, use it. If it only has pure functions, the command still calls sshExec + spawn directly but imports the pure functions from core.

4. Keep CLI-specific code: resolveServer, spinners, prompts, output formatting, backup listing display.

5. Check what `src/commands/restore.ts` imports from `./backup.js` — it imports `listBackups` and `getBackupDir`. After refactor, restore.ts should import these from `../core/backup.js` instead.

**restore.ts refactoring:**

1. Remove duplicated pure functions:
   - `buildStopCoolifyCommand`, `buildStartCoolifyCommand` — check if core/backup.ts has them. If not, add them to core/backup.ts first.

2. If core/backup.ts has a `restoreBackup()` wrapper, use it. Otherwise, keep SSH logic in command but import all pure functions from core.

3. Update imports: `listBackups` and `getBackupDir` from `../core/backup.js` instead of `./backup.js`.

IMPORTANT: Read the FULL core/backup.ts before making changes to understand exactly what's available. Do NOT assume — verify.
  </action>
  <verify>
    <automated>npm run build && npm test -- --testPathPattern="(backup|restore)" 2>&1 | tail -10</automated>
  </verify>
  <done>backup.ts and restore.ts import pure functions from core/backup.ts. No duplicated function definitions. Tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor maintain.ts, update.ts, and snapshot.ts to delegate to core/</name>
  <files>src/commands/maintain.ts, src/commands/update.ts, src/commands/snapshot.ts, src/commands/monitor.ts</files>
  <action>
**maintain.ts refactoring:**

1. Read `src/core/maintain.ts` fully. It has `updateCoolify()`, `restartServer()`, `maintainServer()` async wrappers.

2. Current commands/maintain.ts has 3 subcommands: update, restart, maintain. It duplicates: COOLIFY_UPDATE_CMD (already extracted to constants.ts by Plan 01), SSH update logic, provider restart logic, and the 5-step maintain orchestration.

3. Refactor:
   - `maintainUpdate()` → call `updateCoolify(server)` from core/maintain.ts, map result to spinner/logger output
   - `maintainRestart()` → call core maintain's restart or core/manage.ts's `rebootServer()`, map result
   - `maintainFull()` → call `maintainServer(server, apiToken, { skipReboot })` from core/maintain.ts, map result
   - Keep: resolveServer, promptApiToken, confirmation prompts, spinner/logger output, --all flag handling

4. Remove direct imports of: `createProviderWithToken`, `sshExec`, `axios` (these are now in core/).

**update.ts refactoring:**

1. Current update.ts duplicates the Coolify update SSH logic. Core/maintain.ts has `updateCoolify()`.

2. Refactor:
   - `updateSingleServer()` → call `updateCoolify(server)` from core/maintain.ts, map result
   - Keep: resolveServer, promptApiToken (for --all mode), spinners, output
   - The `--all` mode loops through servers — keep that loop in command, call core per-server

**snapshot.ts refactoring:**

1. Current snapshot.ts calls provider.createSnapshot/listSnapshots/deleteSnapshot directly.

2. Core/snapshot.ts has `createSnapshot()`, `listSnapshots()`, `deleteSnapshot()` wrappers.

3. Refactor:
   - `snapshotCreate()` → call `createSnapshot(server, apiToken)` from core/snapshot.ts
   - `snapshotList()` → call `listSnapshots(server, apiToken)` from core/snapshot.ts
   - `snapshotDelete()` → call `deleteSnapshot(server, snapshotId, apiToken)` from core/snapshot.ts
   - Keep: resolveServer, promptApiToken, confirmation prompts, --all/--dry-run handling, output formatting

**monitor.ts:**

1. Already imports `parseMetrics` from core/logs.ts. Verify it's fully thin. If any inline business logic remains, extract to core.

2. Likely already clean — just verify and move on.

Each command: separate commit.
  </action>
  <verify>
    <automated>npm run build && npm test -- --testPathPattern="(maintain|update|snapshot|monitor)" 2>&1 | tail -10</automated>
  </verify>
  <done>maintain.ts, update.ts, snapshot.ts delegate to core/. monitor.ts verified clean. Tests pass.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. `npm test` passes all tests
3. `grep -rn "sshExec\|createProviderWithToken" src/commands/maintain.ts` — only used for --all token collection, not business logic
4. `grep -rn "provider\.\(createSnapshot\|listSnapshots\|deleteSnapshot\)" src/commands/snapshot.ts` returns nothing
5. `grep -rn "import.*core/backup" src/commands/backup.ts` shows import
6. `grep -rn "import.*core/maintain" src/commands/maintain.ts` shows import
</verification>

<success_criteria>
- backup, restore, maintain, update, snapshot commands delegate business logic to core/
- monitor.ts verified clean
- No duplicated pure function definitions between commands/ and core/
- All commands only handle CLI concerns
- Zero behavior changes
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-cli-core-refactor/01-04-SUMMARY.md`
</output>
