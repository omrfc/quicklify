---
phase: 01-cli-core-refactor
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/commands/secure.ts
  - src/commands/firewall.ts
  - src/commands/domain.ts
autonomous: true
requirements:
  - REF-01
  - REF-03

must_haves:
  truths:
    - "Commands secure.ts, firewall.ts, and domain.ts import all pure functions and constants from their core/ counterparts instead of defining them locally"
    - "No duplicated function definitions exist between commands/ and core/ for secure, firewall, and domain"
    - "CLI output and behavior of all three commands remains identical"
  artifacts:
    - path: "src/commands/secure.ts"
      provides: "Thin CLI wrapper around core/secure.ts"
      contains: "import.*from.*core/secure"
    - path: "src/commands/firewall.ts"
      provides: "Thin CLI wrapper around core/firewall.ts"
      contains: "import.*from.*core/firewall"
    - path: "src/commands/domain.ts"
      provides: "Thin CLI wrapper around core/domain.ts"
      contains: "import.*from.*core/domain"
  key_links:
    - from: "src/commands/secure.ts"
      to: "src/core/secure.ts"
      via: "import { parseSshdConfig, parseAuditResult, buildHardeningCommand, buildFail2banCommand, buildAuditCommand, buildKeyCheckCommand }"
      pattern: "import.*from.*core/secure"
    - from: "src/commands/firewall.ts"
      to: "src/core/firewall.ts"
      via: "import { PROTECTED_PORTS, COOLIFY_PORTS, isValidPort, isProtectedPort, buildUfwRuleCommand, buildFirewallSetupCommand, buildUfwStatusCommand, parseUfwStatus }"
      pattern: "import.*from.*core/firewall"
    - from: "src/commands/domain.ts"
      to: "src/core/domain.ts"
      via: "import { isValidDomain, sanitizeDomain, buildSetFqdnCommand, buildGetFqdnCommand, buildCoolifyCheckCommand, buildDnsCheckCommand, parseDnsResult, parseFqdn }"
      pattern: "import.*from.*core/domain"
---

<objective>
Remove 100% duplicated pure functions from secure.ts, firewall.ts, and domain.ts commands by importing from core/ counterparts.

Purpose: These three command files have the most egregious duplication -- every pure function is character-for-character identical to the core/ version. This is the lowest-risk, highest-impact refactoring target because the core/ already has the identical functions.

Output: Three thinner command files that import pure functions and constants from core/ instead of defining them locally.
</objective>

<execution_context>
@C:/Users/Omrfc/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Omrfc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-cli-core-refactor/01-CONTEXT.md

<interfaces>
<!-- Functions duplicated between commands/ and core/ — commands will import from core/ -->

From src/core/secure.ts (exports):
```typescript
export function parseSshdConfig(content: string): SshdSetting[]
export function parseAuditResult(stdout: string): SecureAuditResult
export function buildHardeningCommand(options?: { port?: number }): string
export function buildFail2banCommand(): string
export function buildAuditCommand(): string
export function buildKeyCheckCommand(): string
export function calculateSecurityScore(audit: SecureAuditResult): number
export async function applySecureSetup(ip: string, options?: { port?: number }): Promise<SecureSetupResult>
export async function runSecureAudit(ip: string): Promise<SecureAuditFullResult>
```

From src/core/firewall.ts (exports):
```typescript
export const PROTECTED_PORTS = [22]
export const COOLIFY_PORTS = [80, 443, 8000, 6001, 6002]
export function isValidPort(port: number): boolean
export function isProtectedPort(port: number): boolean
export function buildFirewallSetupCommand(): string
export function buildUfwRuleCommand(action, port, protocol): string
export function buildUfwStatusCommand(): string
export function parseUfwStatus(stdout: string): FirewallStatus
export async function setupFirewall(ip: string): Promise<FirewallResult>
export async function addFirewallRule(ip, port, protocol): Promise<FirewallResult>
export async function removeFirewallRule(ip, port, protocol): Promise<FirewallResult>
export async function getFirewallStatus(ip: string): Promise<FirewallStatusResult>
```

From src/core/domain.ts (exports):
```typescript
export function isValidDomain(domain: string): boolean
export function sanitizeDomain(input: string): string
export function escapePsqlString(input: string): string
export function buildSetFqdnCommand(domain: string, ssl: boolean): string
export function buildGetFqdnCommand(): string
export function buildCoolifyCheckCommand(): string
export function buildDnsCheckCommand(domain: string): string
export function parseDnsResult(stdout: string): string | null
export function parseFqdn(stdout: string): string | null
export async function setDomain(ip, domain, ssl): Promise<DomainResult>
export async function removeDomain(ip): Promise<DomainResult>
export async function getDomain(ip): Promise<DomainInfoResult>
export async function checkDns(ip, domain): Promise<DnsCheckResult>
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor commands/secure.ts to import pure functions from core/secure.ts</name>
  <files>src/commands/secure.ts</files>
  <action>
1. Remove ALL locally defined pure functions from `src/commands/secure.ts` that are identical to `src/core/secure.ts`:
   - Remove local `parseSshdConfig` (lines 8-38)
   - Remove local `parseAuditResult` (lines 40-73)
   - Remove local `buildHardeningCommand` (lines 75-91)
   - Remove local `buildFail2banCommand` (lines 93-111)
   - Remove local `buildAuditCommand` (lines 113-115)
   - Remove local `buildKeyCheckCommand` (lines 117-119)

2. Add import from core:
   ```typescript
   import {
     parseSshdConfig,
     parseAuditResult,
     buildHardeningCommand,
     buildFail2banCommand,
     buildAuditCommand,
     buildKeyCheckCommand,
   } from "../core/secure.js";
   ```

3. Keep the type import from types (already there): `import type { SshdSetting, SecureAuditResult } from "../types/index.js"`

4. Keep ALL CLI-specific code (the secureCommand function, secureSetup function, secureStatus function, secureAudit function) — these handle prompts, spinners, output formatting. They stay in the command.

5. The `secureSetup` and `secureAudit` functions in commands/secure.ts handle CLI concerns (prompts, spinners, logger output) and call pure functions — they are NOT duplicated in core/. Keep them.

6. Re-export `parseSshdConfig`, `parseAuditResult`, etc. from the command file for backward compatibility — other files may import from `commands/secure.ts`. Check with grep first:
   - `grep -r "from.*commands/secure" src/` — if init.ts imports `secureSetup` from commands/secure.ts, keep that export
   - If nothing imports the pure functions from commands/secure.ts, no re-export needed

IMPORTANT: The CLI-facing functions (secureCommand, secureSetup, secureStatus, secureAudit) remain in commands/secure.ts unchanged. Only the PURE functions move to imports from core/.
  </action>
  <verify>
    <automated>npm run build && npm test -- --testPathPattern="secure" 2>&1 | tail -10</automated>
  </verify>
  <done>commands/secure.ts has zero locally defined pure functions. All pure functions imported from core/secure.ts. Secure command tests pass. Build succeeds.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor commands/firewall.ts to import pure functions from core/firewall.ts</name>
  <files>src/commands/firewall.ts</files>
  <action>
1. Remove ALL locally defined constants and pure functions from `src/commands/firewall.ts` that are identical to `src/core/firewall.ts`:
   - Remove local `PROTECTED_PORTS` (line 8)
   - Remove local `COOLIFY_PORTS` (line 9)
   - Remove local `isValidPort` (lines 11-13)
   - Remove local `isProtectedPort` (lines 15-17)
   - Remove local `buildUfwRuleCommand` (lines 19-25)
   - Remove local `buildFirewallSetupCommand` (lines 27-37)
   - Remove local `buildUfwStatusCommand` (lines 39-41)
   - Remove local `parseUfwStatus` (lines 43-62)

2. Add import from core:
   ```typescript
   import {
     PROTECTED_PORTS,
     COOLIFY_PORTS,
     isValidPort,
     isProtectedPort,
     buildUfwRuleCommand,
     buildFirewallSetupCommand,
     buildUfwStatusCommand,
     parseUfwStatus,
   } from "../core/firewall.js";
   ```

3. Keep ALL CLI-specific functions (firewallCommand, firewallSetup, firewallAdd, firewallRemove, firewallList, firewallStatusCheck) — they handle prompts, spinners, output.

4. Check for external imports: `grep -r "from.*commands/firewall" src/` — init.ts imports `firewallSetup` from commands/firewall.ts, keep that export. Re-export `COOLIFY_PORTS` and `PROTECTED_PORTS` if other files import them from here (check with grep).

IMPORTANT: Keep all async CLI functions. Only remove the duplicated pure functions and constants.
  </action>
  <verify>
    <automated>npm run build && npm test -- --testPathPattern="firewall" 2>&1 | tail -10</automated>
  </verify>
  <done>commands/firewall.ts has zero locally defined pure functions. All imported from core/firewall.ts. Firewall tests pass. Build succeeds.</done>
</task>

<task type="auto">
  <name>Task 3: Refactor commands/domain.ts to import pure functions from core/domain.ts</name>
  <files>src/commands/domain.ts</files>
  <action>
1. Remove ALL locally defined constants and pure functions from `src/commands/domain.ts` that are identical to `src/core/domain.ts`:
   - Remove local `COOLIFY_SOURCE_DIR` (line 7)
   - Remove local `COOLIFY_DB_CONTAINER` (line 8)
   - Remove local `COOLIFY_DB_USER` (line 9)
   - Remove local `COOLIFY_DB_NAME` (line 10)
   - Remove local `isValidDomain` (lines 12-15)
   - Remove local `sanitizeDomain` (lines 17-26)
   - Remove local `escapePsqlString` (lines 28-30)
   - Remove local `buildSetFqdnCommand` (lines 32-42)
   - Remove local `buildGetFqdnCommand` (lines 44-46)
   - Remove local `buildCoolifyCheckCommand` (lines 48-50)
   - Remove local `buildDnsCheckCommand` (lines 52-55)
   - Remove local `parseDnsResult` (lines 57-61)
   - Remove local `parseFqdn` (lines 63-68)

2. Add import from core:
   ```typescript
   import {
     isValidDomain,
     sanitizeDomain,
     buildSetFqdnCommand,
     buildGetFqdnCommand,
     buildCoolifyCheckCommand,
     buildDnsCheckCommand,
     parseDnsResult,
     parseFqdn,
   } from "../core/domain.js";
   ```
   Note: `COOLIFY_DB_CONTAINER` is used inside `domainAdd` to check container output. Import it from core/ if needed, or use the `buildCoolifyCheckCommand` which already encapsulates it.

3. Keep ALL CLI-specific functions (domainCommand, domainAdd, domainRemove, domainCheck, domainList).

4. Check `grep -r "COOLIFY_DB_CONTAINER" src/commands/domain.ts` — if it's used for string matching in the command (checking stdout includes container name), import it from core/domain.ts. Currently core/domain.ts does NOT export it, so either:
   a. Export it from core/domain.ts, OR
   b. Import from src/constants.ts (if Plan 01 already extracted it there)
   Choose option that avoids circular deps. Since the constant is domain-specific, export it from core/domain.ts.

IMPORTANT: Keep all async CLI functions. Only remove the duplicated pure functions and constants.
  </action>
  <verify>
    <automated>npm run build && npm test -- --testPathPattern="domain" 2>&1 | tail -10</automated>
  </verify>
  <done>commands/domain.ts has zero locally defined pure functions or constants. All imported from core/domain.ts. Domain tests pass. Build succeeds.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. `npm test` passes all tests
3. `grep -rn "export function parseSshdConfig" src/commands/secure.ts` returns nothing (removed)
4. `grep -rn "export function isValidPort" src/commands/firewall.ts` returns nothing (removed)
5. `grep -rn "export function isValidDomain" src/commands/domain.ts` returns nothing (removed)
6. `grep -rn "from.*core/secure" src/commands/secure.ts` shows import
7. `grep -rn "from.*core/firewall" src/commands/firewall.ts` shows import
8. `grep -rn "from.*core/domain" src/commands/domain.ts` shows import
</verification>

<success_criteria>
- All three command files import pure functions from core/ instead of defining locally
- Zero duplicated function definitions between commands/ and core/ for secure, firewall, domain
- CLI output and behavior identical (no user-visible changes)
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-cli-core-refactor/01-02-SUMMARY.md`
</output>
