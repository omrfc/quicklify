# Codebase Structure

**Analysis Date:** 2026-02-27

## Directory Layout

```
quicklify/
├── bin/                    # Executable wrappers for npm bin scripts
│   ├── quicklify          # CLI entry point (shebang wrapper → src/index.ts)
│   └── quicklify-mcp      # MCP server entry point (shebang wrapper → src/mcp/index.ts)
├── src/                   # Source code
│   ├── index.ts           # CLI entry point: Command setup and dispatch
│   ├── commands/          # 23 CLI command implementations
│   ├── core/              # 11 business logic modules (no CLI-specific code)
│   ├── providers/         # Cloud provider implementations
│   ├── mcp/               # MCP server and tools
│   ├── types/             # TypeScript interfaces
│   └── utils/             # Cross-cutting utilities
├── tests/                 # Test suites (1758 tests, 64 suites)
│   ├── unit/              # Unit tests (61 files)
│   ├── integration/       # Provider integration tests (4 files)
│   └── e2e/               # End-to-end command tests (10 files)
├── dist/                  # Compiled JavaScript (git-ignored, generated by npm run build)
├── coverage/              # Jest coverage reports (git-ignored)
├── .planning/             # GSD planning documents
├── .github/               # GitHub Actions workflows (CI/CD)
├── package.json           # npm dependencies and scripts
├── tsconfig.json          # TypeScript configuration
├── jest.config.cjs        # Jest test configuration
├── eslint.config.js       # ESLint rules
├── .prettierrc             # Prettier formatting
└── README.md + LICENSE    # Documentation

```

## Directory Purposes

**`bin/`:**
- Purpose: Executable entry points for npm bin scripts
- Contains: Two shell wrapper scripts with shebangs
- Key files: `quicklify`, `quicklify-mcp`
- Note: Actually run compiled JS from dist/ after `npm run build`

**`src/`:**
- Purpose: All TypeScript source code
- Contains: CLI, business logic, cloud providers, utilities
- No subdirectories are optional; all are required

**`src/commands/`:**
- Purpose: CLI command implementations (one command = one file)
- Contains: 23 files, one per command (init.ts, status.ts, backup.ts, etc.)
- Key files:
  - `init.ts`: Deploy new Coolify (longest: 600+ lines)
  - `status.ts`: Check cloud + Coolify status
  - `backup.ts`: Backup and restore Coolify
  - `secure.ts`, `firewall.ts`, `domain.ts`: Security setup
  - `doctor.ts`: Environment and config validation
  - `monitor.ts`, `logs.ts`: Observability
- Pattern: Each exports `async function commandName(options, ...args): Promise<void>`
- Dependencies: Imports from core/, utils/, providers/, types/

**`src/core/`:**
- Purpose: Business logic modules (reusable by both CLI and MCP)
- Contains: 11 files, each a logical operation or concern
- Key files:
  - `status.ts`: Cloud server status + Coolify health checks
  - `provision.ts`: Coolify provisioning workflow
  - `backup.ts`: Backup/restore orchestration
  - `secure.ts`, `firewall.ts`, `domain.ts`: Security operations
  - `manage.ts`: Server lifecycle (add, remove, destroy)
  - `maintain.ts`: Maintenance cycles
  - `logs.ts`: Log retrieval
  - `tokens.ts`: Provider token validation
  - `snapshot.ts`: Snapshot creation/deletion
- Pattern: Pure functions, no console.log() (let CLI format output)
- Dependencies: Utils, Providers, Types (no Commands)

**`src/providers/`:**
- Purpose: Cloud provider API abstractions
- Contains: 5 files
- Key files:
  - `base.ts`: CloudProvider interface definition
  - `hetzner.ts`: Hetzner Cloud API client (350+ lines)
  - `digitalocean.ts`: DigitalOcean API client
  - `vultr.ts`: Vultr API client
  - `linode.ts`: Linode (Akamai) API client (beta)
- Pattern: Each implements CloudProvider interface with methods for:
  - Auth: validateToken()
  - Region/Size: getRegions(), getServerSizes(), getAvailableLocations(), getAvailableServerTypes()
  - Lifecycle: createServer(), getServerStatus(), destroyServer(), rebootServer()
  - Snapshots: createSnapshot(), listSnapshots(), deleteSnapshot()
  - SSH Keys: uploadSshKey()
- Error handling: Axios errors caught, sensitive data stripped before re-throw

**`src/mcp/`:**
- Purpose: Model Context Protocol server for AI/Claude integration
- Contains: 2 files + tools/ subdirectory
- Key files:
  - `server.ts`: MCP server registration (7 tools)
  - `index.ts`: Entrypoint that starts stdio server
  - `tools/serverInfo.ts`: Get server list/status/health
  - `tools/serverLogs.ts`: Fetch logs and metrics
  - `tools/serverManage.ts`: Add/remove/destroy servers
  - `tools/serverMaintain.ts`: Update/restart/maintain
  - `tools/serverSecure.ts`: Security and firewall operations
  - `tools/serverBackup.ts`: Backup/restore
  - `tools/serverProvision.ts`: Provision cloud servers
- Pattern: Each tool has schema (Zod input validation) + handler function
- Dependencies: Core modules (no CLI prompts)

**`src/types/index.ts`:**
- Purpose: Central TypeScript interface repository
- Contains: 50+ interfaces and types
- Key interfaces:
  - CloudProvider (provider interface)
  - ServerRecord (registered server model)
  - Region, ServerSize, ServerConfig, ServerResult (cloud-specific)
  - FirewallRule, FirewallStatus (firewall config)
  - SecureAuditResult, SshdSetting (security audit)
  - BackupManifest (backup metadata)
  - InitOptions, TemplateDefinition (init config)
- Pattern: Interface-first design; all layers depend on types/

**`src/utils/`:**
- Purpose: Reusable utilities for CLI and core logic
- Contains: 16 files
- Key files:
  - `config.ts`: ServerRecord persistence (getServers, saveServer, removeServer, findServer)
  - `ssh.ts`: SSH operations (sshExec, sshExecPty, assertValidIp, checkSshAvailable)
  - `serverSelect.ts`: Interactive server lookup (resolveServer with prompts)
  - `errorMapper.ts`: Provider/SSH/FileSystem error → user-friendly message
  - `providerFactory.ts`: Factory for creating provider instances
  - `prompts.ts`: Interactive CLI prompts (provider, region, size, confirmation)
  - `logger.ts`: Colored output (title, info, success, warning, error) + spinners
  - `yamlConfig.ts`: Parse YAML deployment configs (--config flag)
  - `templates.ts`: Predefined deployment templates (starter, production, dev)
  - `cloudInit.ts`: Generate Coolify installation cloud-init script
  - `sshKey.ts`: Generate/find SSH keys
  - `healthCheck.ts`: Poll for server readiness
  - `updateCheck.ts`: Check for CLI updates on npm
  - `openBrowser.ts`: Open http://server-ip:8000 after deploy
  - `configMerge.ts`: Merge YAML config + CLI flags + prompts
  - `defaults.ts`: Hardcoded defaults (timeouts, API endpoints)
- Pattern: Pure or mostly-pure functions; minimal state

**`tests/`:**
- Purpose: Test suites (1758 tests total)
- Contains: 75 test files organized by type
- Key stats:
  - Unit tests: 61 files (commands, core, utils, providers)
  - Integration tests: 4 files (one per provider)
  - E2E tests: 10 files (command workflows)
- Pattern: Jest with mocked dependencies
  - jest.mock() for utils and providers
  - Sample servers in fixtures
  - CloudProvider mock interface
  - Async/await + done callback support
- Coverage target: Tracked but not enforced (maintained at 80%+)

**`dist/`:**
- Purpose: Compiled JavaScript output
- Generated by: `npm run build` (tsc compiler)
- Git-ignored: Yes (package.json files array excludes dist/)
- Used by: bin/ wrappers after compilation

## Key File Locations

**Entry Points:**
- `src/index.ts`: CLI command registration and dispatch (Commander.js setup)
- `src/mcp/server.ts`: MCP server and tool registration
- `bin/quicklify`: CLI entry wrapper (npm start)
- `bin/quicklify-mcp`: MCP entry wrapper (npm start mcp)

**Configuration:**
- `package.json`: Dependencies, scripts (build, test, lint, format)
- `tsconfig.json`: TypeScript compiler options (module: ESM, target: ES2020, strict: true)
- `jest.config.cjs`: Test runner config (ts-jest, coverage thresholds)
- `eslint.config.js`: Linting rules (ESLint 10 flat config)
- `.prettierrc`: Code formatter settings (2 spaces, trailing comma none)
- `.mcp.json`: MCP server config (name, version, entry point)

**Core Logic:**
- `src/core/status.ts`: Server/Coolify health check
- `src/core/provision.ts`: Initial Coolify setup
- `src/core/backup.ts`: Backup/restore workflow
- `src/utils/config.ts`: Server registry persistence

**Cloud Provider**
- `src/providers/base.ts`: CloudProvider interface definition
- `src/providers/hetzner.ts`: Hetzner Cloud implementation (primary)
- `src/providers/digitalocean.ts`: DigitalOcean implementation

**Utilities**
- `src/utils/errorMapper.ts`: Error → user message translation
- `src/utils/ssh.ts`: SSH command execution and validation
- `src/utils/prompts.ts`: Interactive user selection
- `src/utils/serverSelect.ts`: Server lookup by query

**Testing**
- `tests/unit/`: Individual module tests
- `tests/integration/`: Provider API tests (mocked)
- `tests/e2e/`: End-to-end command flows

## Naming Conventions

**Files:**
- Command file: `<command-name>.ts` in `src/commands/` (e.g., `init.ts`, `status.ts`, `backup.ts`)
- Core module: `<operation-name>.ts` in `src/core/` (e.g., `status.ts`, `backup.ts`)
- Provider file: `<provider-name>.ts` in `src/providers/` (e.g., `hetzner.ts`, `digitalocean.ts`)
- Utility file: `<feature-name>.ts` in `src/utils/` (e.g., `errorMapper.ts`, `serverSelect.ts`)
- MCP tool: `server<Feature>.ts` in `src/mcp/tools/` (e.g., `serverInfo.ts`, `serverBackup.ts`)
- Test file: `<module>.test.ts` in `tests/<type>/` (e.g., `tests/unit/init.test.ts`)

**Directories:**
- camelCase for TypeScript source dirs: `src/commands`, `src/core`, `src/providers`, `src/mcp`, `src/types`, `src/utils`
- camelCase for test dirs: `tests/unit`, `tests/integration`, `tests/e2e`
- kebab-case for build output: `dist/`, `coverage/`

**Functions & Exports:**
- Command handler: `async function <command>Command(options?: Options, ...args): Promise<void>` (e.g., `initCommand`, `statusCommand`)
- Core function: `async function <operation>(...): Promise<T>` (e.g., `checkCoolifyHealth`, `runBackup`)
- Provider method: implements CloudProvider interface (standard names)
- Utility function: `function <verb><Noun>(...): T` (e.g., `mapProviderError`, `resolveServer`, `getServers`)
- Prompt function: `function get<Question>(...): Promise<string>` (e.g., `getProviderConfig`, `getDeploymentConfig`)
- Validator: `function assert<Constraint>(value, context): void` (e.g., `assertValidIp`)

**Variables:**
- camelCase for all variables
- Prefixes for specific types:
  - Mocked: `mocked<Module>` (e.g., `mockedConfig`, `mockedProviderFactory`)
  - Options/config: `<name>Options` or `<name>Config` (e.g., `InitOptions`, `DeploymentConfig`)
  - Spinners: `spinner` (single variable, reused)
  - Providers: `provider` (singular) or `providers` (plural)

## Where to Add New Code

**New CLI Command:**
1. Create `src/commands/<command-name>.ts` with function `<command>Command(options?, ...args): Promise<void>`
2. Add corresponding test in `tests/unit/<command-name>.test.ts` (mock utils/core/providers)
3. Import and register in `src/index.ts`: `.command("<name>").action(commandName)`
4. If command needs business logic (reusable by MCP): Add to `src/core/`

**New Core Module (reusable operation):**
1. Create `src/core/<operation-name>.ts` with pure functions, no prompts
2. Export interface if needed (e.g., `StatusResult`)
3. Add tests in `tests/unit/core-<operation>.test.ts`
4. Commands import and call these functions

**New MCP Tool:**
1. Create `src/mcp/tools/server<Feature>.ts` with:
   - Zod schema for input validation (exported as `server<Feature>Schema`)
   - Handler function `async handle<Feature>(params): Promise<string>` returning JSON
2. Register in `src/mcp/server.ts`: `server.registerTool("<name>", { description, inputSchema, annotations }, handler)`
3. Add test in `tests/unit/mcp-server-<feature>.test.ts`

**New Provider (cloud platform):**
1. Create `src/providers/<provider-name>.ts` implementing CloudProvider interface
2. Update `src/utils/providerFactory.ts` switch statements (createProvider, createProviderWithToken)
3. Update `src/types/index.ts` if new RegionInfo or SizeInfo properties needed
4. Add integration test in `tests/integration/<provider-name>.test.ts`
5. Update CLI prompts in `src/utils/prompts.ts` to include new provider

**New Utility Function:**
1. Create or edit `src/utils/<feature>.ts`
2. Export function from module
3. Add test in `tests/unit/<feature>.test.ts`
4. Import in calling modules

**New Type/Interface:**
1. Add to `src/types/index.ts`
2. All imports: `import type { ... } from "../types/index.js"`

## Special Directories

**`~/.quicklify/` (user home):**
- Purpose: Runtime configuration and backup storage
- Generated: On first command execution
- Committed: No (user-specific, git-ignored)
- Contents:
  - `servers.json`: Registered server list (array of ServerRecord)
  - `backups/<server-name>-<timestamp>/`: Backup directories (tar.gz + manifest.json)

**`.planning/codebase/` (GSD planning):**
- Purpose: Codebase analysis documents for AI orchestration
- Generated: By `/gsd:map-codebase` command
- Committed: Yes (aids future planning)
- Contents:
  - `ARCHITECTURE.md`: Pattern, layers, data flow, abstractions
  - `STRUCTURE.md`: Directory layout, file purposes, naming conventions
  - `CONVENTIONS.md`: Code style, import organization, comments (if focus=quality)
  - `TESTING.md`: Test framework, patterns, fixtures (if focus=quality)
  - `STACK.md`: Languages, frameworks, dependencies (if focus=tech)
  - `INTEGRATIONS.md`: External APIs, databases, auth providers (if focus=tech)
  - `CONCERNS.md`: Technical debt, security issues, performance bottlenecks (if focus=concerns)

**`dist/` (build output):**
- Purpose: Compiled JavaScript from TypeScript
- Generated: By `npm run build` (tsc compiler)
- Committed: No (.gitignore)
- Executed by: bin/ wrappers, npm test, MCP server

**`coverage/` (test coverage reports):**
- Purpose: Jest coverage HTML reports
- Generated: By `npm run test:coverage`
- Committed: No (.gitignore)
- Viewed: `open coverage/lcov-report/index.html`

**`.github/workflows/`:**
- Purpose: GitHub Actions CI/CD
- Contains: test.yml (run tests on 6 matrix combinations), release.yml (publish to npm on tag)
- Committed: Yes

---

*Structure analysis: 2026-02-27*
