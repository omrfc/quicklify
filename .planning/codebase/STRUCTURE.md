# Codebase Structure

**Analysis Date:** 2026-03-02

## Directory Layout

```
quicklify/
├── src/                    # All TypeScript source
│   ├── index.ts            # CLI entry point (Commander.js program)
│   ├── constants.ts        # Shared constants (timeouts, commands, paths)
│   ├── commands/           # 23 CLI command handlers + interactive menu
│   ├── core/               # Business logic (SSH operations, cloud ops)
│   ├── providers/          # Cloud provider API implementations
│   ├── mcp/                # MCP server, tools, utilities
│   │   └── tools/          # 7 MCP tool handlers
│   ├── types/
│   │   └── index.ts        # All shared TypeScript types/interfaces
│   └── utils/              # Shared infrastructure (SSH, config, logging)
├── bin/
│   ├── quicklify           # CLI entrypoint (ESM import of dist/index.js)
│   └── quicklify-mcp       # MCP server entrypoint (ESM import of dist/mcp/index.js)
├── tests/
│   ├── unit/               # Unit + integration tests (co-located by feature)
│   ├── integration/        # Provider-specific integration tests
│   ├── e2e/                # End-to-end CLI tests (Playwright)
│   └── __mocks__/          # Manual Jest mocks
├── dist/                   # Compiled output (gitignored, generated by tsc)
├── .planning/              # GSD planning artifacts
│   ├── codebase/           # Codebase analysis documents (this file)
│   ├── milestones/         # Archived milestone phases
│   └── phases/             # Active planning phases
├── .github/
│   └── workflows/          # CI (test matrix) + publish workflow
├── package.json
├── tsconfig.json
├── tsconfig.test.json
├── jest.config.cjs
├── eslint.config.js
└── quicklify.yml           # Example YAML config for --config flag
```

## Directory Purposes

**`src/commands/`:**
- Purpose: Thin CLI command handlers — argument resolution, interactive prompts, output rendering
- Contains: One `.ts` file per CLI command (23 total), `interactive.ts` for the no-args menu
- Key files:
  - `src/commands/init.ts` — full interactive provisioning with back-navigation wizard
  - `src/commands/interactive.ts` — category-based menu, dispatches to sub-prompts
  - `src/commands/backup.ts` — re-exports core backup helpers for backward compat
- Pattern: Each file exports one `*Command()` async function registered in `src/index.ts`

**`src/core/`:**
- Purpose: Business logic that can be called by both CLI commands and MCP tools
- Contains: Feature-domain files (provision, status, backup, manage, tokens, secure, firewall, domain, logs, maintain, snapshot)
- Key files:
  - `src/core/provision.ts` — full server provisioning pipeline (token → cloud API → IP poll → save)
  - `src/core/manage.ts` — add/remove/destroy server records, SAFE_MODE guard, validation helpers
  - `src/core/backup.ts` — pure command builders + async backup/restore/SCP operations
  - `src/core/tokens.ts` — env-var token resolution, `collectProviderTokensFromEnv()`
- Pattern: Functions return `QuicklifyResult<T>` (`{ success, data?, error?, hint? }`) — no throws

**`src/providers/`:**
- Purpose: Cloud provider HTTP API clients
- Contains: `base.ts` (interface), one class per provider
- Key file: `src/providers/base.ts` — `CloudProvider` interface defining all required methods
- All providers: `HetznerProvider`, `DigitalOceanProvider`, `VultrProvider`, `LinodeProvider`
- Instantiated via: `src/utils/providerFactory.ts` `createProviderWithToken(name, token)`

**`src/mcp/`:**
- Purpose: MCP server exposing Quicklify operations as AI-accessible tools
- Key files:
  - `src/mcp/index.ts` — stdio transport startup
  - `src/mcp/server.ts` — `createMcpServer()` registers all 7 tools with Zod schemas + annotations
  - `src/mcp/utils.ts` — `mcpSuccess()`, `mcpError()`, `resolveServerForMcp()`, `requireProviderToken()`
- Tools in `src/mcp/tools/`: `serverInfo.ts`, `serverLogs.ts`, `serverManage.ts`, `serverMaintain.ts`, `serverSecure.ts`, `serverBackup.ts`, `serverProvision.ts`

**`src/types/`:**
- Purpose: Single source of truth for all shared TypeScript interfaces and types
- Single file: `src/types/index.ts`
- Key types: `ServerRecord`, `ServerMode`, `CloudProvider` (re-exported from providers), `QuicklifyResult<T>`, `DeploymentConfig`, `BackupManifest`, `SnapshotInfo`, `FirewallRule`, `SecureAuditResult`, template types

**`src/utils/`:**
- Purpose: Shared infrastructure used across commands, core, and MCP tools
- Key files:
  - `src/utils/ssh.ts` — `sshExec()`, `sshStream()`, `sshConnect()`, `assertValidIp()`, `sanitizedEnv()`, host key management
  - `src/utils/config.ts` — `getServers()`, `saveServer()`, `removeServer()`, `findServer()` — reads/writes `~/.quicklify/servers.json`
  - `src/utils/providerFactory.ts` — `createProvider()`, `createProviderWithToken()` factory functions
  - `src/utils/logger.ts` — chalk-colored `logger` object + `createSpinner()`
  - `src/utils/errorMapper.ts` — `mapProviderError()`, `mapSshError()`, `sanitizeStderr()`, `mapFileSystemError()`
  - `src/utils/serverSelect.ts` — `resolveServer(query?)`, `selectServer()` — interactive inquirer server picker
  - `src/utils/modeGuard.ts` — `isBareServer()`, `requireCoolifyMode()` — mode enforcement
  - `src/utils/cloudInit.ts` — `getCoolifyCloudInit()`, `getBareCloudInit()` — bash scripts embedded in VPS user-data
  - `src/utils/sshKey.ts` — `findLocalSshKey()`, `generateSshKey()`, `getSshKeyName()` — local key discovery
  - `src/utils/templates.ts` — `TEMPLATES` record, `getTemplateDefaults(name, provider)`
  - `src/utils/yamlConfig.ts` — YAML config file loader for `--config` flag
  - `src/utils/configMerge.ts` — merges CLI flags with YAML config and template defaults
  - `src/utils/healthCheck.ts` — `waitForCoolify(ip, minWait)` — polls Coolify HTTP endpoint
  - `src/utils/updateCheck.ts` — background npm registry version check on CLI startup

**`tests/unit/`:**
- Purpose: All unit and command-level tests (flat, named by feature)
- Contains: 68+ test files covering commands, core, utils, MCP tools
- Naming: `<feature>.test.ts`, `<feature>-<variant>.test.ts` (e.g., `backup-bare.test.ts`, `mcp-server-backup.test.ts`)

**`tests/integration/`:**
- Purpose: Per-provider API integration tests
- Contains: `hetzner.test.ts`, `digitalocean.test.ts`, `vultr.test.ts`, `linode.test.ts`

**`tests/e2e/`:**
- Purpose: Full CLI end-to-end tests via child process spawn
- Contains: `init.test.ts`, `init-config.test.ts`, `init-noninteractive.test.ts`, `destroy.test.ts`, `status.test.ts`, `security-*.test.ts`

**`tests/__mocks__/`:**
- Purpose: Manual Jest mocks for external dependencies

## Key File Locations

**Entry Points:**
- `src/index.ts` — CLI program definition, all 23 command registrations
- `src/mcp/index.ts` — MCP server startup
- `bin/quicklify` — compiled CLI binary shim
- `bin/quicklify-mcp` — compiled MCP binary shim

**Configuration:**
- `src/types/index.ts` — all type definitions
- `src/constants.ts` — provider timing constants, Coolify commands/paths
- `src/utils/templates.ts` — starter/production/dev template defaults
- `tsconfig.json` — TypeScript compilation config
- `jest.config.cjs` — Jest test runner config
- `eslint.config.js` — ESLint rules

**Core Logic:**
- `src/core/provision.ts` — server provisioning pipeline
- `src/core/manage.ts` — add/remove/destroy + validation + SAFE_MODE
- `src/core/backup.ts` — backup and restore (Coolify and bare)
- `src/utils/ssh.ts` — all SSH/SCP execution
- `src/utils/config.ts` — `~/.quicklify/servers.json` I/O

**MCP Surface:**
- `src/mcp/server.ts` — all 7 tool registrations with schemas and descriptions
- `src/mcp/utils.ts` — `mcpSuccess`, `mcpError`, `resolveServerForMcp`, `requireProviderToken`

## Naming Conventions

**Files:**
- camelCase for all TypeScript source files: `providerFactory.ts`, `serverSelect.ts`, `cloudInit.ts`
- kebab-case allowed for test variants: `backup-bare.test.ts`, `mcp-server-info.test.ts`, `init-noninteractive.test.ts`
- Command files match the CLI command name: `backup.ts` → `quicklify backup`
- MCP tool files match the tool name: `serverBackup.ts` → `server_backup` tool

**Exports:**
- Commands: `export async function backupCommand(...)`
- Core: named exports of pure functions and async result-returning functions
- Providers: named class export (`export class HetznerProvider implements CloudProvider`)
- MCP tools: export `handleServer*()` function + `server*Schema` Zod object
- Utils: named exports only, no barrel `index.ts` in `src/utils/`

**Types:**
- Interfaces: PascalCase with descriptive name: `ServerRecord`, `CloudProvider`, `BackupManifest`
- Result types: `*Result` suffix: `ProvisionResult`, `AddServerResult`, `BackupResult`
- Option types: `*Options` suffix: `InitOptions`
- Type unions: PascalCase: `ServerMode = "coolify" | "bare"`

## Where to Add New Code

**New CLI Command:**
- Create: `src/commands/<commandName>.ts` — export `async function <commandName>Command(...)`
- Register: Add `.command()` + `.action()` in `src/index.ts`
- Tests: `tests/unit/<commandName>.test.ts`
- Interactive menu: add to `MENU` in `src/commands/interactive.ts` and `SUB_PROMPTS` if it needs sub-options

**New Core Business Logic Function:**
- If it belongs to an existing domain: add to `src/core/<domain>.ts` (e.g., `src/core/backup.ts`)
- If it's a new domain: create `src/core/<domain>.ts`, export named functions returning `QuicklifyResult<T>`
- Tests: `tests/unit/core-<domain>.test.ts`

**New Cloud Provider:**
- Create: `src/providers/<name>.ts` implementing `CloudProvider` interface from `src/providers/base.ts`
- Register: Add case in both `createProvider()` and `createProviderWithToken()` in `src/utils/providerFactory.ts`
- Add token env var mapping: `src/core/tokens.ts` `ENV_KEYS` map
- Add timing constants: `src/constants.ts` `IP_WAIT` and `COOLIFY_MIN_WAIT` records
- Add template defaults: `src/utils/templates.ts` per template in the `defaults` record
- Tests: `tests/integration/<name>.test.ts`

**New MCP Tool:**
- Create: `src/mcp/tools/server<Feature>.ts` — export `handle*()` handler and `*Schema` Zod object
- Register: Import and call `server.registerTool()` in `src/mcp/server.ts`
- Tests: `tests/unit/mcp-server-<feature>.test.ts`

**Shared Utility:**
- Add to appropriate existing file in `src/utils/` (e.g., error mapping → `src/utils/errorMapper.ts`)
- If genuinely new domain: create `src/utils/<name>.ts` with named exports

## Special Directories

**`.planning/`:**
- Purpose: GSD planning artifacts — codebase analysis, phase plans, milestone archives
- Generated: No
- Committed: Yes

**`dist/`:**
- Purpose: TypeScript compiled output
- Generated: Yes (by `npm run build` / `tsc`)
- Committed: No (gitignored)

**`coverage/`:**
- Purpose: Jest code coverage reports (lcov + HTML)
- Generated: Yes (by `npm run test:coverage`)
- Committed: No (gitignored)

**`~/.quicklify/` (runtime, not in repo):**
- Purpose: User's local config directory — `servers.json` + `backups/`
- Created by: `src/utils/config.ts` `ensureConfigDir()` on first write
- Mode: `0o700` (directory), `0o600` (files) — user-only permissions

---

*Structure analysis: 2026-03-02*
