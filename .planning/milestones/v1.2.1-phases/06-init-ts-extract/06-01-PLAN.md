---
phase: 06-init-ts-extract
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/deploy.ts
  - src/commands/init.ts
autonomous: true
requirements:
  - REF-03

must_haves:
  truths:
    - "src/core/deploy.ts exists and exports deployServer() and uploadSshKeyToProvider() as named exports"
    - "init.ts imports deployServer from ../../core/deploy and delegates to it at both call sites"
    - "wc -l src/commands/init.ts reports fewer than 350 lines"
    - "All existing tests pass without modification to test files"
    - "TypeScript build compiles without errors"
  artifacts:
    - path: "src/core/deploy.ts"
      provides: "deployServer() named export with full deployment logic (SSH key upload, VPS creation, boot wait, IP wait, cloud-init wait, full-setup, success output)"
      contains: "export async function deployServer"
    - path: "src/commands/init.ts"
      provides: "Thin wizard wrapper that collects provider/token/region/size/name via prompts then delegates to deployServer()"
      contains: "import { deployServer } from"
  key_links:
    - from: "src/commands/init.ts"
      to: "src/core/deploy.ts"
      via: "deployServer() import and two call sites"
      pattern: "import.*deployServer.*from.*core/deploy"
---

<objective>
Extract the deployServer() function (~328 lines) and its private helper uploadSshKeyToProvider() (~28 lines) from src/commands/init.ts into a new src/core/deploy.ts module with named exports. Update init.ts to import deployServer from core/deploy and delegate to it at both existing call sites. The wizard state machine (provider selection, token prompt, region/size/name navigation with back-navigation loop) stays in init.ts unchanged.

Purpose: deployServer() is independently testable business logic that does not belong in a wizard wrapper. Extracting it enables unit testing in isolation (Phase 06 Plan 02) and aligns with the core/ architecture pattern established by core/provision.ts.

Output: New src/core/deploy.ts with deployServer() and uploadSshKeyToProvider() exported. Updated src/commands/init.ts under 350 lines that imports and delegates to deployServer().
</objective>

<execution_context>
@C:/Users/Omrfc/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Omrfc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/commands/init.ts
@src/core/provision.ts

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/types/index.ts:
```typescript
export type ServerMode = "coolify" | "bare";
export interface InitOptions {
  provider?: string;
  token?: string;
  region?: string;
  size?: string;
  name?: string;
  fullSetup?: boolean;
  noOpen?: boolean;
  mode?: string;
  config?: string;
  template?: string;
}
```

From src/providers/base.ts:
```typescript
export interface CloudProvider {
  name: string;
  displayName: string;
  createServer(config: ServerConfig): Promise<ServerResult>;
  getServerStatus(id: string): Promise<string>;
  getServerDetails(id: string): Promise<{ ip: string }>;
  uploadSshKey(name: string, publicKey: string): Promise<string>;
  validateToken(token: string): Promise<boolean>;
  getAvailableLocations(): Promise<Region[]>;
  getAvailableServerTypes(region: string, excludeTypes?: string[], mode?: ServerMode): Promise<ServerSize[]>;
}
```

From src/constants.ts (post-Phase-4):
```typescript
export const IP_WAIT: Record<string, { attempts: number; interval: number }>;
export const COOLIFY_MIN_WAIT: Record<string, number>;
// (PROVIDER_REGISTRY, SUPPORTED_PROVIDERS, etc. also available but not needed in deploy.ts)
```

From src/utils/ssh.ts:
```typescript
export function assertValidIp(ip: string): void;
export function sanitizedEnv(): NodeJS.ProcessEnv;
export function sshExec(ip: string, command: string): Promise<{ code: number; stdout: string; stderr: string }>;
```

From src/utils/healthCheck.ts:
```typescript
export async function waitForCoolify(ip: string, minWaitMs?: number): Promise<boolean>;
```

From src/utils/config.ts:
```typescript
export function saveServer(record: ServerRecord): void;
```

From src/commands/firewall.ts:
```typescript
export async function firewallSetup(ip: string, name: string, dryRun: boolean, isBare?: boolean): Promise<void>;
```

From src/commands/secure.ts:
```typescript
export async function secureSetup(ip: string, name: string, port?: number, dryRun?: boolean, isBare?: boolean): Promise<void>;
```

From src/utils/sshKey.ts:
```typescript
export function findLocalSshKey(): string | null;
export function generateSshKey(): string | null;
export function getSshKeyName(): string;
```

From src/utils/prompts.ts (used only in deployServer for retry prompts — must be re-exported):
```typescript
export function getServerNameConfig(): Promise<string>;
export function getLocationConfig(provider: CloudProvider, excludeLocations?: string[]): Promise<string>;
export function getServerTypeConfig(provider: CloudProvider, region: string, excludeTypes?: string[], mode?: ServerMode): Promise<string>;
export const BACK_SIGNAL: string;
```

From src/utils/openBrowser.ts:
```typescript
export function openBrowser(url: string): void;
```

From src/utils/errorMapper.ts:
```typescript
export function getErrorMessage(error: unknown): string;
export function mapProviderError(error: unknown, provider: string): string;
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create src/core/deploy.ts with extracted deployServer() and uploadSshKeyToProvider()</name>
  <files>src/core/deploy.ts</files>
  <action>
Create `src/core/deploy.ts` by extracting the `deployServer()` function (lines 283–611 of init.ts) and the `uploadSshKeyToProvider()` helper (lines 254–281 of init.ts) from init.ts verbatim. Export both functions as named exports. Fix import paths to use correct relative paths from `src/core/` (one level deeper than `src/commands/`).

**Import path adjustments (commands/ → core/ prefix change: `../` stays `../`, but commands/ imports become `../commands/`):**
- `../providers/base.js` → `../providers/base.js` (unchanged)
- `../utils/cloudInit.js` → `../utils/cloudInit.js` (unchanged)
- `../utils/logger.js` → `../utils/logger.js` (unchanged)
- `../utils/errorMapper.js` → `../utils/errorMapper.js` (unchanged)
- `../utils/openBrowser.js` → `../utils/openBrowser.js` (unchanged)
- `../utils/ssh.js` → `../utils/ssh.js` (unchanged)
- `../utils/sshKey.js` → `../utils/sshKey.js` (unchanged)
- `../utils/config.js` → `../utils/config.js` (unchanged)
- `../utils/healthCheck.js` → `../utils/healthCheck.js` (unchanged)
- `../utils/prompts.js` → `../utils/prompts.js` (unchanged)
- `../constants.js` → `../constants.js` (unchanged)
- `../types/index.js` → `../types/index.js` (unchanged)
- `./firewall.js` (from commands/) → `../commands/firewall.js` (cross-directory reference)
- `./secure.js` (from commands/) → `../commands/secure.js` (cross-directory reference)

NOTE: `child_process` import for `spawnSync` must also be included (used in the `assertValidIp` + `ssh-keygen -R` blocks in deployServer).

**File structure for src/core/deploy.ts:**
```typescript
import { spawnSync } from "child_process";
import type { CloudProvider } from "../providers/base.js";
import type { ServerMode } from "../types/index.js";
import { getCoolifyCloudInit, getBareCloudInit } from "../utils/cloudInit.js";
import { logger, createSpinner } from "../utils/logger.js";
import { getErrorMessage, mapProviderError } from "../utils/errorMapper.js";
import { openBrowser } from "../utils/openBrowser.js";
import { assertValidIp, sanitizedEnv, sshExec } from "../utils/ssh.js";
import { findLocalSshKey, generateSshKey, getSshKeyName } from "../utils/sshKey.js";
import { saveServer } from "../utils/config.js";
import { waitForCoolify } from "../utils/healthCheck.js";
import {
  BACK_SIGNAL,
  getServerNameConfig,
  getLocationConfig,
  getServerTypeConfig,
} from "../utils/prompts.js";
import { firewallSetup } from "../commands/firewall.js";
import { secureSetup } from "../commands/secure.js";
import { IP_WAIT, COOLIFY_MIN_WAIT } from "../constants.js";

export async function uploadSshKeyToProvider(provider: CloudProvider): Promise<string[]> {
  // ... (exact body from init.ts lines 254-281)
}

export async function deployServer(
  providerChoice: string,
  providerWithToken: CloudProvider,
  region: string,
  serverSize: string,
  serverName: string,
  fullSetup?: boolean,
  noOpen?: boolean,
  mode?: string,
): Promise<void> {
  // ... (exact body from init.ts lines 292-611)
}
```

Copy the function bodies verbatim from init.ts — do NOT alter logic, comments, or structure. Only the import paths change.
  </action>
  <verify>
    <automated>npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>src/core/deploy.ts exists, exports deployServer() and uploadSshKeyToProvider() as named exports, and TypeScript compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Update src/commands/init.ts to import from core/deploy and remove extracted code</name>
  <files>src/commands/init.ts</files>
  <action>
Modify `src/commands/init.ts` to:

1. **Remove** the `uploadSshKeyToProvider()` function definition (lines 254–281).
2. **Remove** the `deployServer()` function definition (lines 283–611).
3. **Remove** any imports that are now only used by the deleted functions and NOT by `initCommand()` itself. Specifically:
   - `spawnSync` from `"child_process"` — only used in deployServer, remove it
   - `getCoolifyCloudInit`, `getBareCloudInit` from `"../utils/cloudInit.js"` — only used in deployServer, remove them
   - `waitForCoolify` from `"../utils/healthCheck.js"` — only used in deployServer, remove it
   - `openBrowser` from `"../utils/openBrowser.js"` — only used in deployServer, remove it
   - `assertValidIp`, `sanitizedEnv`, `sshExec` from `"../utils/ssh.js"` — only used in deployServer, remove them
   - `findLocalSshKey`, `generateSshKey`, `getSshKeyName` from `"../utils/sshKey.js"` — only used in deployServer, remove them
   - `saveServer` from `"../utils/config.js"` — only used in deployServer, remove it
   - `firewallSetup` from `"./firewall.js"` — only used in deployServer, remove it
   - `secureSetup` from `"./secure.js"` — only used in deployServer, remove it
   - `getErrorMessage`, `mapProviderError` from `"../utils/errorMapper.js"` — only used in deployServer, remove them
   - `IP_WAIT`, `COOLIFY_MIN_WAIT` from `"../constants.js"` — only used in deployServer, remove them (keep `SUPPORTED_PROVIDERS`, `PROVIDER_ENV_KEYS`, `invalidProviderError`)

4. **Add** a new import at the top of the file:
```typescript
import { deployServer } from "../core/deploy.js";
```

5. **Keep** all existing logic in `initCommand()` unchanged — the wizard state machine (provider selection, token validation, region/size/name back-navigation loop, confirmDeployment) stays exactly as is.

6. **Verify** both existing call sites in `initCommand()` already call `deployServer(...)` — they are at approximately line 209 and line 242. These call sites need NO modification since `deployServer` is already called by name in the current code.

**Expected final structure of init.ts:**
```
imports (reduced set — wizard-only dependencies + deployServer from core/deploy)
export async function initCommand(options: InitOptions = {}): Promise<void> {
  // YAML config loading
  // template validation
  // provider selection (interactive or --provider flag)
  // template defaults application
  // API token resolution (env var or prompt)
  // token validation
  // region/size/name collection (with back-navigation loop OR non-interactive)
  // deployServer(...) call — delegated
}
```

After removing the extracted functions, run `wc -l src/commands/init.ts` to confirm the file is under 350 lines.
  </action>
  <verify>
    <automated>wc -l src/commands/init.ts && npx tsc --noEmit && npm test -- --silent 2>&1 | tail -10</automated>
  </verify>
  <done>
- `wc -l src/commands/init.ts` reports fewer than 350 lines
- `src/commands/init.ts` imports `deployServer` from `../../core/deploy` (relative: `../core/deploy.js`)
- TypeScript compiles without errors
- All existing tests pass (init-bare.test.ts, init-fullsetup.test.ts, e2e/init*.test.ts — no test file modifications)
  </done>
</task>

</tasks>

<verification>
After all tasks complete, run the following checks:

1. **Line count under 350:**
```bash
wc -l src/commands/init.ts
```
Expected: fewer than 350 lines

2. **deploy.ts exports exist:**
```bash
grep -n "export async function deployServer\|export async function uploadSshKeyToProvider" src/core/deploy.ts
```
Expected: 2 matches

3. **init.ts delegates to deployServer:**
```bash
grep -n "import.*deployServer.*from.*core/deploy\|deployServer(" src/commands/init.ts
```
Expected: 1 import line + 2 call sites = 3 matches

4. **All tests pass:**
```bash
npm test
```
Expected: all existing tests pass, no test files modified

5. **Build succeeds:**
```bash
npm run build
```
Expected: clean exit, no TypeScript errors
</verification>

<success_criteria>
- `wc -l src/commands/init.ts` reports fewer than 350 lines (success criterion #1)
- `src/core/deploy.ts` exists with `export async function deployServer(...)` (success criterion #2)
- `src/commands/init.ts` contains `import { deployServer } from "../core/deploy.js"` (success criterion #3)
- All existing init-related tests pass without modification (success criterion #4)
- TypeScript build passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-init-ts-extract/06-01-SUMMARY.md`
</output>
