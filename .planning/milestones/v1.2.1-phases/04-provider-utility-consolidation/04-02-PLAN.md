---
phase: 04-provider-utility-consolidation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/providers/base.ts
  - src/providers/hetzner.ts
  - src/providers/digitalocean.ts
  - src/providers/vultr.ts
  - src/providers/linode.ts
autonomous: true
requirements:
  - REF-02

must_haves:
  truths:
    - "stripSensitiveData is defined in exactly one place (base.ts) and all 4 providers import it"
    - "No provider file contains a local stripSensitiveData function definition"
    - "The function signature and behavior are unchanged (strips axios error headers, config data, and request)"
    - "All 2047+ existing tests pass without modification"
  artifacts:
    - path: "src/providers/base.ts"
      provides: "stripSensitiveData exported function"
      exports: ["stripSensitiveData", "CloudProvider"]
      contains: "export function stripSensitiveData"
    - path: "src/providers/hetzner.ts"
      provides: "Hetzner provider importing stripSensitiveData from base"
      contains: "import { stripSensitiveData }"
    - path: "src/providers/digitalocean.ts"
      provides: "DigitalOcean provider importing stripSensitiveData from base"
      contains: "import { stripSensitiveData }"
    - path: "src/providers/vultr.ts"
      provides: "Vultr provider importing stripSensitiveData from base"
      contains: "import { stripSensitiveData }"
    - path: "src/providers/linode.ts"
      provides: "Linode provider importing stripSensitiveData from base"
      contains: "import { stripSensitiveData }"
  key_links:
    - from: "src/providers/base.ts"
      to: "src/providers/hetzner.ts"
      via: "import { stripSensitiveData }"
      pattern: "import.*stripSensitiveData.*from.*base"
    - from: "src/providers/base.ts"
      to: "src/providers/digitalocean.ts"
      via: "import { stripSensitiveData }"
      pattern: "import.*stripSensitiveData.*from.*base"
---

<objective>
Move the identical `stripSensitiveData()` function from all 4 provider files into `src/providers/base.ts` as a shared named export, then update all providers to import it.

Purpose: Eliminate a 4x copy-pasted security function so any future fix to error data stripping is applied in one place, preventing accidental token leaks from a missed provider file.

Output: `base.ts` exports `stripSensitiveData`; all 4 provider files import it; no local definitions remain.
</objective>

<execution_context>
@C:/Users/Omrfc/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Omrfc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-provider-utility-consolidation/04-CONTEXT.md

@src/providers/base.ts
@src/providers/hetzner.ts
@src/providers/digitalocean.ts
@src/providers/vultr.ts
@src/providers/linode.ts

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/providers/base.ts (CURRENT — will be extended with stripSensitiveData):
```typescript
import type { Region, ServerSize, ServerConfig, ServerResult, SnapshotInfo, ServerMode } from "../types/index.js";

export interface CloudProvider {
  name: string;
  displayName: string;
  validateToken(token: string): Promise<boolean>;
  getRegions(): Region[];
  getServerSizes(): ServerSize[];
  getAvailableLocations(): Promise<Region[]>;
  getAvailableServerTypes(location: string, mode?: ServerMode): Promise<ServerSize[]>;
  uploadSshKey(name: string, publicKey: string): Promise<string>;
  createServer(config: ServerConfig): Promise<ServerResult>;
  getServerStatus(serverId: string): Promise<string>;
  getServerDetails(serverId: string): Promise<ServerResult>;
  destroyServer(serverId: string): Promise<void>;
  rebootServer(serverId: string): Promise<void>;
  createSnapshot(serverId: string, name: string): Promise<SnapshotInfo>;
  listSnapshots(serverId: string): Promise<SnapshotInfo[]>;
  deleteSnapshot(snapshotId: string): Promise<void>;
  getSnapshotCostEstimate(serverId: string): Promise<string>;
}
```

From src/providers/hetzner.ts (identical in all 4 providers — will be REMOVED):
```typescript
function stripSensitiveData(error: unknown): void {
  if (axios.isAxiosError(error)) {
    if (error.config) {
      error.config.headers = undefined as unknown as typeof error.config.headers;
      error.config.data = undefined;
    }
    (error as unknown as Record<string, unknown>).request = undefined;
  }
}
```

Provider import pattern (CURRENT):
```typescript
import axios from "axios";
import type { CloudProvider } from "./base.js";
```

Provider import pattern (AFTER):
```typescript
import axios from "axios";
import type { CloudProvider } from "./base.js";
import { stripSensitiveData } from "./base.js";
```
Note: Can combine type and value imports from base.js into one statement:
```typescript
import { stripSensitiveData, type CloudProvider } from "./base.js";
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add stripSensitiveData to base.ts and update all providers</name>
  <files>src/providers/base.ts, src/providers/hetzner.ts, src/providers/digitalocean.ts, src/providers/vultr.ts, src/providers/linode.ts</files>
  <action>
**Step 1 — Add to base.ts:**

Add `import axios from "axios";` at the top of `src/providers/base.ts` (currently it has NO imports, only type imports indirectly via the interface).

Add the following EXPORTED function AFTER the `CloudProvider` interface definition:

```typescript
export function stripSensitiveData(error: unknown): void {
  if (axios.isAxiosError(error)) {
    if (error.config) {
      error.config.headers = undefined as unknown as typeof error.config.headers;
      error.config.data = undefined;
    }
    (error as unknown as Record<string, unknown>).request = undefined;
  }
}
```

The function body is identical to all 4 existing copies. No behavior change.

**Step 2 — Update all 4 provider files:**

For each of `hetzner.ts`, `digitalocean.ts`, `vultr.ts`, `linode.ts`:

1. **Remove** the local `function stripSensitiveData(error: unknown): void { ... }` definition (lines 5-13 in each file). Delete the entire function block.

2. **Update the import** from `./base.js` to include `stripSensitiveData`:
   - CURRENT: `import type { CloudProvider } from "./base.js";`
   - AFTER: `import { stripSensitiveData, type CloudProvider } from "./base.js";`

   This combines the type import and value import into one ESM statement.

3. **Do NOT change** any call sites within the provider files — they already call `stripSensitiveData(error)` which will now resolve to the imported function instead of the local one. Same name, same signature, same behavior.

4. **Verify** that each provider file still has `import axios from "axios";` at the top — they need it for their own API calls (not just for stripSensitiveData). Do NOT remove the axios import from provider files.

**Important:** base.ts currently has ONLY type imports (via the interface). Adding `import axios from "axios";` makes it a module with a runtime dependency. This is intentional — base.ts is the right home for the shared provider utility function. The axios import is already a dependency of the project.
  </action>
  <verify>
    <automated>npx tsc --noEmit && npm test -- --silent 2>&1 | tail -5</automated>
  </verify>
  <done>
- `src/providers/base.ts` exports `stripSensitiveData` and `CloudProvider` interface
- `grep -rn 'function stripSensitiveData' src/providers/` returns exactly ONE match: `src/providers/base.ts`
- All 4 provider files import `stripSensitiveData` from `./base.js`
- All 2047+ tests pass without modification
- Build compiles without errors
  </done>
</task>

</tasks>

<verification>
After task completes, run the following checks:

1. **Only one definition of stripSensitiveData in providers/:**
```bash
grep -rn 'function stripSensitiveData' src/providers/
```
Expected: exactly 1 match in `src/providers/base.ts`

2. **All 4 providers import from base:**
```bash
grep -rn "import.*stripSensitiveData.*from.*base" src/providers/
```
Expected: 4 matches (hetzner, digitalocean, vultr, linode)

3. **All tests pass:**
```bash
npm test
```
Expected: 2047+ tests pass, 0 failures

4. **Build succeeds:**
```bash
npm run build
```
Expected: clean exit

5. **Lint passes:**
```bash
npx eslint src/providers/ --max-warnings=0
```
Expected: 0 errors, 0 warnings
</verification>

<success_criteria>
- `grep -rn 'function stripSensitiveData' src/providers/` returns only one match: `src/providers/base.ts`
- All 4 provider files have `import { stripSensitiveData` from `./base.js`
- No provider file has a local stripSensitiveData function definition
- `src/providers/base.ts` has `import axios from "axios"` and exports both `CloudProvider` and `stripSensitiveData`
- All existing tests pass without modification
- Build succeeds and ESLint reports zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-provider-utility-consolidation/04-02-SUMMARY.md`
</output>
