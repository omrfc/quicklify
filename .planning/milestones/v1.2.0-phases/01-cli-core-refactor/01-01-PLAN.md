---
phase: 01-cli-core-refactor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/constants.ts
  - src/types/index.ts
  - src/core/provision.ts
  - src/core/maintain.ts
  - src/core/status.ts
  - src/commands/init.ts
  - src/commands/maintain.ts
  - src/commands/update.ts
  - src/commands/status.ts
autonomous: true
requirements:
  - REF-02
  - REF-03
  - REF-04
  - REF-05

must_haves:
  truths:
    - "All shared constants (IP_WAIT, COOLIFY_MIN_WAIT, BOOT_MAX_ATTEMPTS, COOLIFY_UPDATE_CMD, COOLIFY_RESTART_CMD) are defined once in src/constants.ts and imported everywhere"
    - "A QuicklifyResult<T> generic Result type is defined in src/types/index.ts for use by core/ functions"
    - "No magic numbers or duplicate constant definitions remain in commands/ or core/ files"
  artifacts:
    - path: "src/constants.ts"
      provides: "Single source of truth for all shared constants"
      exports: ["IP_WAIT", "COOLIFY_MIN_WAIT", "BOOT_MAX_ATTEMPTS", "BOOT_INTERVAL", "COOLIFY_UPDATE_CMD", "COOLIFY_RESTART_CMD", "COOLIFY_SOURCE_DIR", "COOLIFY_DB_CONTAINER", "COOLIFY_DB_USER", "COOLIFY_DB_NAME"]
    - path: "src/types/index.ts"
      provides: "QuicklifyResult<T> generic result type"
      contains: "QuicklifyResult"
  key_links:
    - from: "src/commands/init.ts"
      to: "src/constants.ts"
      via: "import IP_WAIT, COOLIFY_MIN_WAIT"
      pattern: "import.*from.*constants"
    - from: "src/core/provision.ts"
      to: "src/constants.ts"
      via: "import IP_WAIT, BOOT_MAX_ATTEMPTS"
      pattern: "import.*from.*constants"
    - from: "src/core/maintain.ts"
      to: "src/constants.ts"
      via: "import COOLIFY_UPDATE_CMD"
      pattern: "import.*from.*constants"
---

<objective>
Extract all shared constants and define the Result type pattern used across the refactoring.

Purpose: Establish the foundational shared modules that all subsequent refactoring plans depend on. Constants currently duplicated between init.ts/provision.ts, maintain.ts/update.ts, and status.ts must be centralized. The Result type pattern (`{ success, data?, error? }`) standardizes how core/ functions return results.

Output: `src/constants.ts` with all shared constants, `src/types/index.ts` extended with `QuicklifyResult<T>`, and all existing consumers updated to import from the new locations.
</objective>

<execution_context>
@C:/Users/Omrfc/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Omrfc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-cli-core-refactor/01-CONTEXT.md

<interfaces>
<!-- Current duplicated constants that will be extracted -->

From src/commands/init.ts (lines 29-42):
```typescript
const IP_WAIT: Record<string, { attempts: number; interval: number }> = {
  hetzner:      { attempts: 10, interval: 3000 },
  digitalocean: { attempts: 20, interval: 3000 },
  vultr:        { attempts: 40, interval: 5000 },
  linode:       { attempts: 30, interval: 5000 },
};
const COOLIFY_MIN_WAIT: Record<string, number> = {
  hetzner: 60000, digitalocean: 120000, vultr: 180000, linode: 120000,
};
```

From src/core/provision.ts (lines 33-41):
```typescript
const IP_WAIT: Record<string, { attempts: number; interval: number }> = { /* identical */ };
const BOOT_MAX_ATTEMPTS = 30;
const BOOT_INTERVAL = 1000;
```

From src/commands/maintain.ts and src/core/maintain.ts:
```typescript
const COOLIFY_UPDATE_CMD = "curl -fsSL https://cdn.coollabs.io/coolify/install.sh | bash";
```

From src/commands/status.ts:
```typescript
const COOLIFY_RESTART_CMD = "cd /data/coolify/source && docker compose -f ...";
```

From src/commands/domain.ts and src/core/domain.ts:
```typescript
const COOLIFY_SOURCE_DIR = "/data/coolify/source";
const COOLIFY_DB_CONTAINER = "coolify-db";
const COOLIFY_DB_USER = "coolify";
const COOLIFY_DB_NAME = "coolify";
```

Current core/ Result types already in use (pattern to standardize):
```typescript
// From src/core/manage.ts
export interface AddServerResult { success: boolean; server?: ServerRecord; error?: string; }
export interface DestroyServerResult { success: boolean; server?: ServerRecord; cloudDeleted: boolean; localRemoved: boolean; error?: string; hint?: string; }

// From src/core/secure.ts
export interface SecureSetupResult { success: boolean; sshHardening: boolean; fail2ban: boolean; sshKeyCount: number; error?: string; hint?: string; }
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create src/constants.ts and extract all shared constants</name>
  <files>src/constants.ts, src/commands/init.ts, src/core/provision.ts, src/commands/maintain.ts, src/commands/update.ts, src/core/maintain.ts, src/commands/status.ts, src/core/domain.ts</files>
  <action>
1. Create `src/constants.ts` with ALL constants that are duplicated between commands/ and core/:

```typescript
// Provider-specific IP wait configuration (IP assignment latency varies significantly)
export const IP_WAIT: Record<string, { attempts: number; interval: number }> = {
  hetzner:      { attempts: 10, interval: 3000 },   // 30s (instant IP)
  digitalocean: { attempts: 20, interval: 3000 },   // 60s
  vultr:        { attempts: 40, interval: 5000 },   // 200s (slowest IP assignment)
  linode:       { attempts: 30, interval: 5000 },   // 150s
};

// Provider-specific minimum wait before first Coolify health check
export const COOLIFY_MIN_WAIT: Record<string, number> = {
  hetzner: 60000, digitalocean: 120000, vultr: 180000, linode: 120000,
};

// Server boot polling
export const BOOT_MAX_ATTEMPTS = 30;
export const BOOT_INTERVAL = 1000;

// Coolify commands
export const COOLIFY_UPDATE_CMD = "curl -fsSL https://cdn.coollabs.io/coolify/install.sh | bash";
export const COOLIFY_RESTART_CMD = "cd /data/coolify/source && docker compose -f docker-compose.yml -f docker-compose.prod.yml restart coolify";

// Coolify database
export const COOLIFY_SOURCE_DIR = "/data/coolify/source";
export const COOLIFY_DB_CONTAINER = "coolify-db";
export const COOLIFY_DB_USER = "coolify";
export const COOLIFY_DB_NAME = "coolify";
```

2. Update all consumers to import from `src/constants.ts` instead of defining locally:
   - `src/commands/init.ts`: Remove local `IP_WAIT` and `COOLIFY_MIN_WAIT` definitions, add `import { IP_WAIT, COOLIFY_MIN_WAIT } from "../constants.js"`
   - `src/core/provision.ts`: Remove local `IP_WAIT`, `BOOT_MAX_ATTEMPTS`, `BOOT_INTERVAL`, add imports from `../constants.js`. Also remove the `// TODO: v1.2.0'da init.ts ile birleştirilecek` comment
   - `src/commands/maintain.ts`: Remove local `COOLIFY_UPDATE_CMD`, import from `../constants.js`
   - `src/commands/update.ts`: Remove local `COOLIFY_UPDATE_CMD`, import from `../constants.js`
   - `src/core/maintain.ts`: Remove local `COOLIFY_UPDATE_CMD`, import from `../constants.js`
   - `src/commands/status.ts`: Remove local `COOLIFY_RESTART_CMD`, import from `../constants.js`
   - `src/core/domain.ts`: Remove local constants, import from `../constants.js`
   - NOTE: Do NOT touch `src/commands/domain.ts` — all domain command changes (constant imports + pure function removal) are handled by Plan 01-02 Task 3 to avoid parallel execution conflicts

3. Only move constants used in 2+ places. Constants used in only one file stay where they are.

IMPORTANT: Do NOT change any behavior. Only move constant definitions and update imports. Each file's functional output must remain identical.
  </action>
  <verify>
    <automated>npm run build && npm test 2>&1 | tail -5</automated>
  </verify>
  <done>src/constants.ts exists with all shared constants. All consumers import from it. No local duplicates remain. Build passes. All 1758 tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Define QuicklifyResult generic type in src/types/index.ts</name>
  <files>src/types/index.ts</files>
  <action>
Add the `QuicklifyResult<T>` generic type to `src/types/index.ts`. This type standardizes how core/ functions return results (success/failure with optional data and error info).

Add at the END of the existing file (after BackupManifest):

```typescript
// Result pattern for core/ functions (no exceptions thrown)
export interface QuicklifyResult<T = void> {
  success: boolean;
  data?: T;
  error?: string;
  hint?: string;
}
```

This is the ONLY change in this task. Do NOT modify any existing core/ functions yet to use this type -- that happens in subsequent plans when each command is refactored. The existing domain-specific result types (AddServerResult, DestroyServerResult, etc.) continue working. Later plans may migrate them or keep them alongside QuicklifyResult.

Per user decision: "Result pattern kullanılacak ({ success: boolean, data?, error? }) — exception fırlatılmayacak". This type implements that decision. The exact shape (generic T for data) is Claude's discretion.
  </action>
  <verify>
    <automated>npm run build && npm test 2>&1 | tail -3</automated>
  </verify>
  <done>QuicklifyResult<T> type exported from src/types/index.ts. Build passes. No existing tests broken.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds (TypeScript compilation)
2. `npm test` passes all 1758 tests
3. `grep -r "const IP_WAIT" src/` shows only src/constants.ts
4. `grep -r "const COOLIFY_UPDATE_CMD" src/` shows only src/constants.ts
5. `grep -r "const COOLIFY_RESTART_CMD" src/` shows only src/constants.ts
6. `grep -r "QuicklifyResult" src/types/index.ts` shows the type definition
</verification>

<success_criteria>
- All shared constants defined exactly once in src/constants.ts
- All existing consumers import from src/constants.ts (no local duplicates)
- QuicklifyResult<T> type available for subsequent plans
- Zero test regressions
- Zero behavior changes
</success_criteria>

<output>
After completion, create `.planning/phases/01-cli-core-refactor/01-01-SUMMARY.md`
</output>
