---
phase: 03-mcp-refactor
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/mcp/tools/serverBackup.ts
  - src/mcp/tools/serverMaintain.ts
  - src/mcp/tools/serverLogs.ts
  - src/mcp/tools/serverSecure.ts
  - src/mcp/server.ts
  - tests/unit/mcp-server-backup.test.ts
  - tests/unit/mcp-server-maintain.test.ts
  - tests/unit/mcp-server-logs.test.ts
  - tests/unit/mcp-server-secure.test.ts
autonomous: true
requirements: [MCP-01, MCP-03, MCP-04]

must_haves:
  truths:
    - "MCP backup-create routes bare servers to createBareBackup() instead of createBackup()"
    - "MCP backup-restore routes bare servers to restoreBareBackup() instead of restoreBackup()"
    - "MCP update/maintain actions reject bare servers with clear error message"
    - "MCP logs action blocks coolify service on bare servers, defaults to system"
    - "MCP tool descriptions in server.ts mention bare mode where relevant"
    - "All 4 tools use shared utils from mcp/utils.ts (resolveServerForMcp, mcpSuccess, mcpError)"
    - "Existing Coolify server behavior unchanged across all 4 tools"
  artifacts:
    - path: "src/mcp/tools/serverBackup.ts"
      provides: "Backup tool with bare mode routing"
      exports: ["serverBackupSchema", "handleServerBackup"]
    - path: "src/mcp/tools/serverMaintain.ts"
      provides: "Maintain tool with bare mode guards"
      exports: ["serverMaintainSchema", "handleServerMaintain"]
    - path: "src/mcp/tools/serverLogs.ts"
      provides: "Logs tool with bare mode service guard"
      exports: ["serverLogsSchema", "handleServerLogs"]
    - path: "src/mcp/tools/serverSecure.ts"
      provides: "Secure tool refactored to use shared utils"
      exports: ["serverSecureSchema", "handleServerSecure"]
    - path: "src/mcp/server.ts"
      provides: "Updated tool descriptions for bare mode awareness"
  key_links:
    - from: "src/mcp/tools/serverBackup.ts"
      to: "src/core/backup.ts"
      via: "routes to createBareBackup/restoreBareBackup for bare servers"
      pattern: "isBareServer.*createBareBackup"
    - from: "src/mcp/tools/serverMaintain.ts"
      to: "src/utils/modeGuard.ts"
      via: "uses requireCoolifyMode to block bare servers"
      pattern: "requireCoolifyMode"
    - from: "src/mcp/tools/serverLogs.ts"
      to: "src/utils/modeGuard.ts"
      via: "uses isBareServer for coolify service guard"
      pattern: "isBareServer"
---

<objective>
Refactor serverBackup, serverMaintain, serverLogs, and serverSecure MCP tools to support bare mode and use shared utilities. Update tool descriptions in server.ts for bare mode awareness.

Purpose: Complete the MCP refactoring by making remaining 4 tools bare-mode-aware, consistent with CLI commands from Phase 2. Update server.ts descriptions so Claude knows about bare mode capabilities.
Output: Four refactored MCP tools with bare mode support, updated descriptions in server.ts.
</objective>

<execution_context>
@C:/Users/Omrfc/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Omrfc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-mcp-refactor/03-CONTEXT.md
@.planning/phases/03-mcp-refactor/03-01-SUMMARY.md

<interfaces>
<!-- From Plan 01 (src/mcp/utils.ts) -->
```typescript
export type McpResponse = { content: Array<{ type: "text"; text: string }>; isError?: boolean };
export function resolveServerForMcp(params: { server?: string }, servers: ServerRecord[]): ServerRecord | undefined;
export function mcpSuccess(data: Record<string, unknown>): McpResponse;
export function mcpError(error: string, hint?: string, suggestedActions?: Array<{ command: string; reason: string }>): McpResponse;
export function requireProviderToken(provider: string): { token: string } | { error: McpResponse };
```

<!-- From Phase 2 (bare mode core functions) -->
From src/core/backup.ts:
```typescript
export async function createBareBackup(ip: string, serverName: string, provider: string): Promise<BackupResult>;
export async function restoreBareBackup(ip: string, serverName: string, backupId: string): Promise<RestoreResult>;
export async function createBackup(ip: string, serverName: string, provider: string): Promise<BackupResult>;
export async function restoreBackup(ip: string, serverName: string, backupId: string): Promise<RestoreResult>;
```

From src/utils/modeGuard.ts:
```typescript
export function isBareServer(server: ServerRecord): boolean;
export function requireCoolifyMode(server: ServerRecord, commandName: string): string | null;
```

From src/core/logs.ts:
```typescript
export type LogService = "coolify" | "docker" | "system";
export async function fetchServerLogs(ip: string, service: LogService, lines: number): Promise<LogResult>;
export async function fetchServerMetrics(ip: string, includeContainers: boolean): Promise<MetricResult>;
```
</interfaces>
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: Add bare mode to serverBackup and serverMaintain tools</name>
  <files>src/mcp/tools/serverBackup.ts, src/mcp/tools/serverMaintain.ts, tests/unit/mcp-server-backup.test.ts, tests/unit/mcp-server-maintain.test.ts</files>
  <behavior>
    - serverBackup backup-create: bare server routes to createBareBackup() instead of createBackup()
    - serverBackup backup-create: coolify server still uses createBackup() unchanged
    - serverBackup backup-restore: bare server routes to restoreBareBackup() instead of restoreBackup()
    - serverBackup backup-restore: bare success shows service restart hint
    - serverBackup backup-list: works for both modes (backup dir is server-name based, mode independent)
    - serverBackup: uses resolveServerForMcp, mcpSuccess, mcpError from mcp/utils
    - serverBackup: removes local resolveServer function
    - serverMaintain update: bare server blocked with requireCoolifyMode error
    - serverMaintain maintain: bare server blocked with requireCoolifyMode error
    - serverMaintain restart: bare server NOT blocked (reboot is mode-independent, cloud API operation)
    - serverMaintain: coolify servers work exactly as before
    - serverMaintain: uses resolveServerForMcp, mcpSuccess, mcpError from mcp/utils
    - serverMaintain: removes local resolveServer function
  </behavior>
  <action>
    **serverBackup.ts changes:**
    1. Import `isBareServer` from `../../utils/modeGuard.js`
    2. Import `createBareBackup, restoreBareBackup` from `../../core/backup.js` (add to existing import)
    3. Import `resolveServerForMcp, mcpSuccess, mcpError, requireProviderToken` from `../utils.js`
    4. Remove local `resolveServer` function, replace call with `resolveServerForMcp(params, servers)`
    5. In `backup-create`: before calling `createBackup`, check `if (isBareServer(server))` → call `createBareBackup(server.ip, server.name, server.provider)` instead
    6. In `backup-restore`: check `if (isBareServer(server))` → call `restoreBareBackup(server.ip, server.name, params.backupId)`, and on success include hint about restarting services
    7. Replace inline JSON.stringify response patterns with mcpSuccess/mcpError
    8. Replace inline token checks in snapshot actions with requireProviderToken

    **serverMaintain.ts changes:**
    1. Import `requireCoolifyMode` from `../../utils/modeGuard.js`
    2. Import `resolveServerForMcp, mcpSuccess, mcpError, requireProviderToken` from `../utils.js`
    3. Remove local `resolveServer` function, replace with `resolveServerForMcp`
    4. In `update` action: after server resolution, add `const modeError = requireCoolifyMode(server, "update"); if (modeError) return mcpError(modeError, "Use SSH to manage bare servers directly");`
    5. In `maintain` action: same requireCoolifyMode guard
    6. `restart` action: NO mode guard (reboot is cloud API, mode-independent)
    7. Replace inline response patterns with mcpSuccess/mcpError
    8. Replace inline token checks with requireProviderToken

    Write tests FIRST. Add test cases for bare mode routing in backup and mode guards in maintain.
  </action>
  <verify>
    <automated>npx jest tests/unit/mcp-server-backup.test.ts tests/unit/mcp-server-maintain.test.ts --no-coverage</automated>
  </verify>
  <done>serverBackup routes bare to createBareBackup/restoreBareBackup; serverMaintain blocks update/maintain for bare; shared utils used; existing tests pass</done>
</task>

<task type="auto" tdd="true">
  <name>Task 2: Add bare mode to serverLogs, refactor serverSecure, and update server.ts descriptions</name>
  <files>src/mcp/tools/serverLogs.ts, src/mcp/tools/serverSecure.ts, src/mcp/server.ts, tests/unit/mcp-server-logs.test.ts, tests/unit/mcp-server-secure.test.ts</files>
  <behavior>
    - serverLogs logs: bare server + service:'coolify' → error with hint to use 'system'
    - serverLogs logs: bare server + no explicit service → defaults to 'system' (not 'coolify')
    - serverLogs logs: bare server + service:'system' or 'docker' → works normally
    - serverLogs monitor: works for both modes (system metrics are mode-independent)
    - serverLogs: uses resolveServerForMcp, mcpSuccess, mcpError from mcp/utils
    - serverLogs: removes local resolveServer function
    - serverSecure: uses resolveServerForMcp, mcpSuccess, mcpError from mcp/utils
    - serverSecure: removes local resolveServer function
    - serverSecure: no logic changes (secure/firewall/domain work on bare servers per Phase 2)
    - server.ts descriptions: mention Coolify and bare mode where relevant
  </behavior>
  <action>
    **serverLogs.ts changes:**
    1. Import `isBareServer` from `../../utils/modeGuard.js`
    2. Import `resolveServerForMcp, mcpSuccess, mcpError` from `../utils.js`
    3. Remove local `resolveServer` function, replace with `resolveServerForMcp`
    4. In `logs` action: after server resolution:
       - If `isBareServer(server)` and `service === "coolify"`: return `mcpError("Coolify logs not available on bare servers", "Use service: 'system' or 'docker' for bare servers", [{ command: \`server_logs { action: 'logs', server: '${server.name}', service: 'system' }\`, reason: "View system journal instead" }])`
       - If `isBareServer(server)` and `service === "coolify"` from default (user didn't explicitly pass service): silently switch to `"system"` — but since the schema has `.default("coolify")`, we cannot distinguish user-explicit vs default. Use the same approach as CLI: if bare and service is "coolify", return error with hint (consistent with `src/commands/logs.ts` Phase 2 behavior)
    5. Replace inline response patterns with mcpSuccess/mcpError

    **serverSecure.ts changes:**
    1. Import `resolveServerForMcp, mcpSuccess, mcpError` from `../utils.js`
    2. Remove local `resolveServer` function, replace with `resolveServerForMcp`
    3. Replace inline response patterns with mcpSuccess/mcpError
    4. No logic changes — secure/firewall/domain are mode-independent per Phase 2

    **server.ts description updates:**
    Update these tool descriptions:
    - `server_info`: "...Actions: 'list' all servers, 'status' check cloud provider + Coolify/bare status, 'health' check Coolify reachability or SSH access for bare servers..."
    - `server_manage`: "...Actions: 'add' registers an existing Coolify or bare server... Pass mode:'bare' for servers without Coolify."
    - `server_maintain`: "...'update' runs Coolify update via SSH (Coolify servers only), 'restart' reboots server via cloud provider API..."
    - `server_backup`: "...Backup: 'backup-create' backs up Coolify DB + config or system config for bare servers..."
    - `server_provision`: "Provision a new server on a cloud provider. Default: Coolify auto-install. Pass mode:'bare' for generic VPS without Coolify."
    - `server_logs`: "...from Coolify container (Coolify servers), Docker service, or system journal..."
    - `server_secure`: unchanged (works on both modes)

    Write tests FIRST for bare mode logs behavior. Existing tests must pass.
  </action>
  <verify>
    <automated>npx jest tests/unit/mcp-server-logs.test.ts tests/unit/mcp-server-secure.test.ts --no-coverage && npm run build</automated>
  </verify>
  <done>serverLogs blocks coolify service on bare; serverSecure uses shared utils; server.ts descriptions updated for bare mode; build passes</done>
</task>

</tasks>

<verification>
1. `npm run build` — TypeScript compiles without errors
2. `npx jest tests/unit/mcp-server-backup.test.ts tests/unit/mcp-server-maintain.test.ts tests/unit/mcp-server-logs.test.ts tests/unit/mcp-server-secure.test.ts --no-coverage` — all tests pass
3. `npm test` — full suite passes, no regressions
4. `grep -rn "function resolveServer" src/mcp/tools/` — should return 0 matches (all replaced by shared util)
5. `grep -n "bare" src/mcp/server.ts` — confirms bare mode mentioned in descriptions
</verification>

<success_criteria>
- serverBackup routes bare servers to createBareBackup/restoreBareBackup
- serverMaintain blocks update/maintain on bare servers with clear error
- serverLogs blocks coolify service on bare servers with hint
- serverSecure uses shared utils, no logic changes
- All 4 tools use resolveServerForMcp/mcpSuccess/mcpError from mcp/utils
- Local resolveServer functions removed from all 4 tools
- server.ts descriptions mention bare mode where relevant
- No breaking changes to existing schemas or behavior
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-mcp-refactor/03-03-SUMMARY.md`
</output>
