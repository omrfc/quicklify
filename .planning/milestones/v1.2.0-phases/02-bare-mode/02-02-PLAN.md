---
phase: 02-bare-mode
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/commands/init.ts
  - src/commands/add.ts
  - src/core/provision.ts
  - src/index.ts
  - src/core/manage.ts
autonomous: true
requirements: [BARE-01]

must_haves:
  truths:
    - "User can run 'quicklify init --mode bare' and get a provisioned VPS without Coolify"
    - "Bare init uses bare cloud-init script (no Coolify installation)"
    - "Bare init completion shows SSH info and IP only (no browser opened, no Coolify health check)"
    - "ServerRecord saved with mode:'bare' after bare init"
    - "User can run 'quicklify add --mode bare' to register an existing bare server"
    - "Bare add skips Coolify verification entirely"
    - "Provisioned bare server record includes mode:'bare'"
  artifacts:
    - path: "src/commands/init.ts"
      provides: "init command with --mode flag support"
      contains: "mode"
    - path: "src/core/provision.ts"
      provides: "provisionServer with bare mode path"
      contains: "getBareCloudInit"
    - path: "src/commands/add.ts"
      provides: "add command with --mode flag support"
      contains: "mode"
    - path: "src/index.ts"
      provides: "Commander.js --mode option on init and add commands"
      contains: "--mode"
    - path: "src/core/manage.ts"
      provides: "addServerRecord with mode param"
      contains: "mode"
  key_links:
    - from: "src/core/provision.ts"
      to: "src/utils/cloudInit.ts"
      via: "getBareCloudInit import"
      pattern: "getBareCloudInit"
    - from: "src/commands/init.ts"
      to: "src/core/provision.ts"
      via: "provisionServer with mode config"
      pattern: "mode.*bare"
    - from: "src/index.ts"
      to: "src/commands/init.ts"
      via: "Commander --mode option"
      pattern: "--mode"
---

<objective>
Implement the init --mode bare and add --mode bare provisioning paths.

Purpose: This is the core user-facing feature -- users can provision and register bare servers without Coolify. The init command uses a bare cloud-init script, skips Coolify health check, and saves with mode:'bare'. The add command skips Coolify verification for bare mode.
Output: Working `quicklify init --mode bare` and `quicklify add --mode bare` commands.
</objective>

<execution_context>
@C:/Users/Omrfc/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Omrfc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-bare-mode/02-CONTEXT.md
@.planning/phases/02-bare-mode/02-01-SUMMARY.md

<interfaces>
<!-- Contracts from Plan 01 that this plan depends on -->

From src/types/index.ts (after Plan 01):
```typescript
export type ServerMode = "coolify" | "bare";

export interface ServerRecord {
  id: string;
  name: string;
  provider: string;
  ip: string;
  region: string;
  size: string;
  createdAt: string;
  mode?: ServerMode;
}

export interface InitOptions {
  provider?: string;
  token?: string;
  region?: string;
  size?: string;
  name?: string;
  fullSetup?: boolean;
  config?: string;
  template?: string;
  noOpen?: boolean;
  mode?: ServerMode;
}
```

From src/utils/cloudInit.ts (after Plan 01):
```typescript
export function getCoolifyCloudInit(serverName: string): string;
export function getBareCloudInit(serverName: string): string;
```

From src/core/provision.ts:
```typescript
export interface ProvisionConfig {
  provider: string;
  region?: string;
  size?: string;
  name: string;
  template?: string;
}
export interface ProvisionResult {
  success: boolean;
  server?: ServerRecord;
  error?: string;
  hint?: string;
}
export async function provisionServer(config: ProvisionConfig): Promise<ProvisionResult>;
```

From src/core/manage.ts:
```typescript
export interface AddServerParams {
  provider: string;
  ip: string;
  name: string;
  skipVerify?: boolean;
  apiToken?: string;
}
export interface AddServerResult {
  success: boolean;
  server?: ServerRecord;
  coolifyStatus?: string;
  error?: string;
}
export async function addServerRecord(params: AddServerParams): Promise<AddServerResult>;
```
</interfaces>
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: Add bare mode to provisioning (core + CLI init + index.ts)</name>
  <files>src/core/provision.ts, src/commands/init.ts, src/index.ts, tests/unit/provision.test.ts, tests/unit/init.test.ts</files>
  <behavior>
    - Test: provisionServer with mode='bare' calls getBareCloudInit instead of getCoolifyCloudInit
    - Test: provisionServer with mode='bare' saves ServerRecord with mode:'bare'
    - Test: provisionServer without mode calls getCoolifyCloudInit (backward compat)
    - Test: provisionServer without mode saves ServerRecord with mode:'coolify'
    - Test: initCommand with mode='bare' does NOT call waitForCoolify
    - Test: initCommand with mode='bare' does NOT call openBrowser
  </behavior>
  <action>
    1. **src/core/provision.ts** -- Add mode to ProvisionConfig and provisioning logic:
       - Add `mode?: ServerMode` to `ProvisionConfig` interface
       - Import `getBareCloudInit` from cloudInit.ts and `ServerMode` from types
       - In `provisionServer()`, step 8 (cloud-init generation):
         ```typescript
         const mode = config.mode || "coolify";
         const cloudInit = mode === "bare"
           ? getBareCloudInit(config.name)
           : getCoolifyCloudInit(config.name);
         ```
       - In step 12 (save record), add `mode` to the ServerRecord:
         ```typescript
         const record: ServerRecord = {
           ...existing fields,
           mode,
         };
         ```
       - Return the record with mode set

    2. **src/commands/init.ts** -- Add mode support to CLI init:
       - The `options: InitOptions` already has `mode` from Plan 01
       - After server provisioning succeeds, check mode:
         - If `mode === "bare"`: Skip `waitForCoolify()`, skip `openBrowser()`, instead show SSH connection info:
           ```
           logger.success("Bare server ready!");
           logger.info(`SSH: ssh root@${serverIp}`);
           logger.info(`IP: ${serverIp}`);
           logger.info("Mode: bare (no platform installed)");
           ```
         - If `mode !== "bare"`: Existing Coolify flow unchanged (waitForCoolify + openBrowser)
       - Pass `options.mode` through to `provisionServer` call (or `deployServer` internal function) when constructing ProvisionConfig
       - Note: init.ts uses its own deployment flow (not core/provision.ts directly for CLI). The mode flag must be threaded through the internal `deployServer` function. Specifically:
         - Pass `mode` to the cloud-init selection: `mode === "bare" ? getBareCloudInit(name) : getCoolifyCloudInit(name)`
         - After server creation + IP assignment: if bare, skip Coolify wait and browser
         - Set `mode` on the saved ServerRecord

    3. **src/index.ts** -- Register --mode flag on init command:
       - Add `.option("--mode <mode>", "Server mode: coolify (default) or bare")` to the init command definition
       - This makes `options.mode` available in initCommand

    4. Update existing tests to cover mode branching.
  </action>
  <verify>
    <automated>npx jest tests/unit/provision.test.ts tests/unit/init.test.ts --no-coverage 2>&1 | tail -10</automated>
  </verify>
  <done>init --mode bare provisions without Coolify, saves mode:'bare', skips health check and browser. Default mode='coolify' unchanged.</done>
</task>

<task type="auto" tdd="true">
  <name>Task 2: Add bare mode to add command (core manage + CLI add + index.ts)</name>
  <files>src/core/manage.ts, src/commands/add.ts, src/index.ts, tests/unit/manage.test.ts, tests/unit/add.test.ts</files>
  <behavior>
    - Test: addServerRecord with mode='bare' skips Coolify verification entirely (coolifyStatus='skipped')
    - Test: addServerRecord with mode='bare' saves ServerRecord with mode:'bare'
    - Test: addServerRecord without mode performs Coolify verification (existing behavior)
    - Test: addServerRecord without mode saves ServerRecord with mode:'coolify'
    - Test: addCommand with mode='bare' shows "bare" in success output, not "Coolify"
  </behavior>
  <action>
    1. **src/core/manage.ts** -- Add mode to AddServerParams:
       - Import `ServerMode` from types
       - Add `mode?: ServerMode` to `AddServerParams` interface
       - In `addServerRecord()`:
         - Resolve mode: `const mode = params.mode || "coolify";`
         - If `mode === "bare"`, skip the entire Coolify verification block (set `coolifyStatus = "skipped"`)
         - Add `mode` to the saved ServerRecord: `{ ...record, mode }`
         - For coolify mode: existing verification logic unchanged

    2. **src/commands/add.ts** -- Thread --mode flag:
       - Add `mode?: string` to the AddOptions interface
       - Pass `mode: options.mode as ServerMode | undefined` to `addServerRecord()`
       - Adjust success output:
         - If mode='bare': show "Bare server added" instead of Coolify status messages
         - Default name prompt: change default from "coolify-server" to mode-aware: `mode === "bare" ? "bare-server" : "coolify-server"`

    3. **src/index.ts** -- Register --mode flag on add command:
       - Add `.option("--mode <mode>", "Server mode: coolify (default) or bare")` to the add command definition

    4. Update existing add/manage tests to cover mode branching.
  </action>
  <verify>
    <automated>npx jest tests/unit/manage.test.ts tests/unit/add.test.ts --no-coverage 2>&1 | tail -10</automated>
  </verify>
  <done>add --mode bare registers server with mode:'bare', skips Coolify verification. Default mode='coolify' with existing Coolify verification unchanged.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- `npm test` passes all existing + new tests
- `npm run lint` passes
- `quicklify init --help` shows --mode option
- `quicklify add --help` shows --mode option
</verification>

<success_criteria>
- `quicklify init --mode bare` provisions without Coolify, shows SSH info instead of Coolify dashboard
- `quicklify add --mode bare` registers server without Coolify verification
- Both commands save ServerRecord with mode:'bare'
- Default behavior (no --mode flag) is identical to before (backward compatible)
- All tests pass, build + lint clean
</success_criteria>

<output>
After completion, create `.planning/phases/02-bare-mode/02-02-SUMMARY.md`
</output>
